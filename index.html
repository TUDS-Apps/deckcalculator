<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TUDS Pro Deck Estimator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23294656'/%3E%3Cpath d='M6 10h20v3H6zM6 15h20v3H6zM6 20h20v3H6z' fill='%23F5E6D3'/%3E%3Cpath d='M10 8v18M16 8v18M22 8v18' stroke='%23294656' stroke-width='1.5'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="deckcalculatorstyles.css" />
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Three.js 3D Library -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="deckCalcjs/firebase.js"></script>
    <script src="deckCalcjs/app.js?v=10" type="module"></script>
  </head>
  <body>
    <!-- Development Warning Modal - dismissible once per day -->
    <div id="devWarningOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99999;display:none;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:12px;max-width:480px;width:90%;padding:32px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="font-size:48px;margin-bottom:16px;">&#9888;</div>
        <h2 style="font-size:22px;font-weight:700;color:#b91c1c;margin:0 0 12px;">Development In Progress</h2>
        <p style="font-size:15px;color:#374151;line-height:1.6;margin:0 0 24px;">
          This app is currently being developed.<br><strong>Do not use for production.</strong>
        </p>
        <button id="devWarningDismiss" style="background:#294656;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:15px;font-weight:600;cursor:pointer;">
          I Understand
        </button>
      </div>
    </div>
    <script>
      (function() {
        var today = new Date().toISOString().slice(0, 10);
        var dismissed = localStorage.getItem('devWarningDismissed');
        var overlay = document.getElementById('devWarningOverlay');
        if (dismissed !== today) {
          overlay.style.display = 'flex';
        }
        document.getElementById('devWarningDismiss').addEventListener('click', function() {
          localStorage.setItem('devWarningDismissed', today);
          overlay.remove();
        });
      })();
    </script>

    <!-- Welcome Modal - shown on app load for mode selection -->
    <div id="welcomeModal" class="welcome-modal hidden">
      <div class="welcome-modal-content">
        <div class="welcome-modal-header">
          <img src="https://tuds.ca/cdn/shop/files/TUDS_logo.svg?v=1676653488"
               alt="TUDS" class="welcome-logo">
          <h2>TUDS Pro Deck Estimator</h2>
        </div>

        <div class="welcome-modal-body">
          <h3 class="welcome-prompt">What are you building today?</h3>

          <div class="welcome-mode-grid">
            <button type="button" class="welcome-mode-card" data-mode="full_build">
              <div class="welcome-mode-icon">
                <img src="icons/mode_full_build.png" alt="Full Deck Build">
              </div>
              <div class="welcome-mode-label">Full Deck Build</div>
              <div class="welcome-mode-desc">Complete deck with framing, decking, and railing</div>
            </button>
            <button type="button" class="welcome-mode-card" data-mode="framing_only">
              <div class="welcome-mode-icon">
                <img src="icons/mode_framing_only.png" alt="Framing Only">
              </div>
              <div class="welcome-mode-label">Framing Only</div>
              <div class="welcome-mode-desc">Structural takeoff &mdash; joists, beams, posts, footings</div>
            </button>
            <button type="button" class="welcome-mode-card" data-mode="decking_only">
              <div class="welcome-mode-icon">
                <img src="icons/mode_decking_only.png" alt="Decking Only">
              </div>
              <div class="welcome-mode-label">Decking Only</div>
              <div class="welcome-mode-desc">Deck board layout and materials</div>
            </button>
            <button type="button" class="welcome-mode-card" data-mode="railing_only">
              <div class="welcome-mode-icon">
                <img src="icons/mode_railing_only.png" alt="Railing Only">
              </div>
              <div class="welcome-mode-label">Railing Only</div>
              <div class="welcome-mode-desc">Railing components and hardware</div>
            </button>
            <button type="button" class="welcome-mode-card" data-mode="custom">
              <div class="welcome-mode-icon">
                <img src="icons/mode_custom.png" alt="Custom Combo">
              </div>
              <div class="welcome-mode-label">Custom Combo</div>
              <div class="welcome-mode-desc">Pick which components you need</div>
            </button>
          </div>

          <!-- Custom Combo inline checkboxes (shown when custom selected) -->
          <div id="welcomeCustomComboOptions" class="welcome-custom-combo hidden">
            <div class="custom-combo-label">Select components:</div>
            <label class="custom-combo-checkbox">
              <input type="checkbox" id="welcomeCustomFraming" checked> Framing
            </label>
            <label class="custom-combo-checkbox">
              <input type="checkbox" id="welcomeCustomDecking" checked> Decking
            </label>
            <label class="custom-combo-checkbox">
              <input type="checkbox" id="welcomeCustomRailing" checked> Railing
            </label>
          </div>

          <!-- Project name field -->
          <div class="welcome-project-field">
            <label for="welcomeProjectName">Project Name <span class="optional-label">(optional)</span></label>
            <input type="text" id="welcomeProjectName" value="Untitled Deck"
                   placeholder="e.g., Smith Residence - Backyard Deck" maxlength="100">
          </div>
        </div>

        <div class="welcome-modal-footer">
          <a href="#" class="welcome-sign-in-link" onclick="event.preventDefault(); if(window.openAuthModal) openAuthModal(); else if(window.openProjectsModal) openProjectsModal();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
              <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" />
              <path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd" />
            </svg>
            Sign in to save projects
          </a>
          <button type="button" id="welcomeStartBtn" class="btn btn-primary welcome-start-btn" disabled>
            Start Designing
          </button>
        </div>
      </div>
    </div>

    <div class="app-shell">
      <div class="deck-calculator-header">
        <div class="header-content">
          <img
            src="https://tuds.ca/cdn/shop/files/TUDS_logo.svg?v=1676653488"
            alt="The Ultimate Deck Shop"
            class="header-logo"
          />
          <div class="header-text">
            <h1 class="text-xl md:text-2xl font-bold text-white">
              TUDS Pro Deck Estimator
            </h1>
            <p class="header-subtitle">by The Ultimate Deck Shop</p>
          </div>
        </div>
        <div class="header-actions">
          <!-- User Auth Button -->
          <div id="userAuthContainer" class="user-auth-container">
            <!-- Signed Out State -->
            <button type="button" id="signInBtn" class="header-action-btn auth-btn" title="Sign In" onclick="openAuthModal()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
              </svg>
              <span>Sign In</span>
            </button>
            <!-- Signed In State (hidden by default) -->
            <div id="userMenuBtn" class="user-menu hidden">
              <button type="button" class="header-action-btn user-btn" onclick="toggleUserMenu()">
                <div class="user-avatar" id="userAvatar">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
                  </svg>
                </div>
                <span id="userDisplayName" class="user-name">User</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 chevron">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
              </button>
              <div id="userDropdown" class="user-dropdown hidden">
                <div class="user-dropdown-header">
                  <span id="userEmail" class="user-email">user@example.com</span>
                </div>
                <div class="user-dropdown-divider"></div>
                <button type="button" class="user-dropdown-item" onclick="openFeedbackAdmin()" id="feedbackAdminBtn" style="display: none;">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293c.121-.233.362-.393.642-.413 1.198-.087 2.382-.226 3.55-.414 1.437-.232 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.29 41.29 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                  </svg>
                  View Feedback
                </button>
                <button type="button" class="user-dropdown-item" onclick="handleSignOut()">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M6 10a.75.75 0 01.75-.75h9.546l-1.048-.943a.75.75 0 111.004-1.114l2.5 2.25a.75.75 0 010 1.114l-2.5 2.25a.75.75 0 11-1.004-1.114l1.048-.943H6.75A.75.75 0 016 10z" clip-rule="evenodd" />
                  </svg>
                  Sign Out
                </button>
              </div>
            </div>
          </div>
          <button type="button" id="adminBtn" class="header-action-btn" title="Admin Settings" onclick="openAdminLogin()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 018.82 1h2.36a1 1 0 01.98.804l.331 1.652a6.993 6.993 0 011.929 1.115l1.598-.54a1 1 0 011.186.447l1.18 2.044a1 1 0 01-.205 1.251l-1.267 1.113a7.047 7.047 0 010 2.228l1.267 1.113a1 1 0 01.206 1.25l-1.18 2.045a1 1 0 01-1.187.447l-1.598-.54a6.993 6.993 0 01-1.929 1.115l-.33 1.652a1 1 0 01-.98.804H8.82a1 1 0 01-.98-.804l-.331-1.652a6.993 6.993 0 01-1.929-1.115l-1.598.54a1 1 0 01-1.186-.447l-1.18-2.044a1 1 0 01.205-1.251l1.267-1.114a7.05 7.05 0 010-2.227L1.821 7.773a1 1 0 01-.206-1.25l1.18-2.045a1 1 0 011.187-.447l1.598.54A6.993 6.993 0 017.51 3.456l.33-1.652zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
            <span>Admin</span>
          </button>
          <button type="button" id="helpWizardBtn" class="help-wizard-trigger" title="Help & Tutorial" onclick="startHelpWizard()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.061-1.061 3 3 0 112.871 5.026v.345a.75.75 0 01-1.5 0v-.5c0-.72.57-1.172 1.081-1.287A1.5 1.5 0 108.94 6.94zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <span>Help</span>
          </button>
          <button type="button" id="feedbackBtn" class="help-wizard-trigger" title="Report Issue" onclick="openFeedbackModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293c.121-.233.362-.393.642-.413 1.198-.087 2.382-.226 3.55-.414 1.437-.232 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.29 41.29 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <span>Feedback</span>
          </button>
        </div>
      </div>

      <!-- Main App Container -->
      <div id="main-layout-container" class="main-layout">
        <!-- Input Panel -->
        <div id="input-panel">
          <!-- Horizontal Progress Bar -->
          <div class="progress-bar" id="progressBar">
            <!-- Dynamically populated by JavaScript -->
          </div>
          <div class="info-card wizard-panel">

            <!-- Wizard Step Content Container -->
            <div class="wizard-content">

            <!-- Step 0: Build Mode Selection -->
            <div id="wizard-step-mode" class="wizard-step-content active" data-step-id="mode">
              <h2 class="wizard-step-title">What are you building today?</h2>
              <div class="panel-content">
                <div class="mode-selection-grid">
                  <button type="button" class="mode-card" data-mode="full_build" onclick="selectBuildMode('full_build')">
                    <div class="mode-card-icon">
                      <img src="icons/mode_full_build.png" alt="Full Deck Build" class="mode-card-img">
                    </div>
                    <div class="mode-card-label">Full Deck Build</div>
                    <div class="mode-card-desc">Complete deck with framing, decking, and railing</div>
                  </button>
                  <button type="button" class="mode-card" data-mode="framing_only" onclick="selectBuildMode('framing_only')">
                    <div class="mode-card-icon">
                      <img src="icons/mode_framing_only.png" alt="Framing Only" class="mode-card-img">
                    </div>
                    <div class="mode-card-label">Framing Only</div>
                    <div class="mode-card-desc">Structural takeoff &mdash; joists, beams, posts, footings</div>
                  </button>
                  <button type="button" class="mode-card" data-mode="decking_only" onclick="selectBuildMode('decking_only')">
                    <div class="mode-card-icon">
                      <img src="icons/mode_decking_only.png" alt="Decking Only" class="mode-card-img">
                    </div>
                    <div class="mode-card-label">Decking Only</div>
                    <div class="mode-card-desc">Deck board layout and materials</div>
                  </button>
                  <button type="button" class="mode-card" data-mode="railing_only" onclick="selectBuildMode('railing_only')">
                    <div class="mode-card-icon">
                      <img src="icons/mode_railing_only.png" alt="Railing Only" class="mode-card-img">
                    </div>
                    <div class="mode-card-label">Railing Only</div>
                    <div class="mode-card-desc">Railing components and hardware</div>
                  </button>
                  <button type="button" class="mode-card" data-mode="custom" onclick="selectBuildMode('custom')">
                    <div class="mode-card-icon">
                      <img src="icons/mode_custom.png" alt="Custom Combo" class="mode-card-img">
                    </div>
                    <div class="mode-card-label">Custom Combo</div>
                    <div class="mode-card-desc">Pick which components you need</div>
                  </button>
                </div>

                <!-- Custom Combo Checkboxes (hidden by default) -->
                <div id="customComboOptions" class="custom-combo-options hidden">
                  <div class="custom-combo-label">Select components:</div>
                  <label class="custom-combo-checkbox">
                    <input type="checkbox" checked onchange="toggleCustomComponent('framing')"> Framing
                  </label>
                  <label class="custom-combo-checkbox">
                    <input type="checkbox" checked onchange="toggleCustomComponent('decking')"> Decking
                  </label>
                  <label class="custom-combo-checkbox">
                    <input type="checkbox" checked onchange="toggleCustomComponent('railing')"> Railing
                  </label>
                  <button type="button" class="btn btn-primary btn-full-width mt-3" onclick="confirmCustomCombo()">
                    Continue
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 1: Draw Shape -->
            <div id="wizard-step-draw" class="wizard-step-content hidden" data-step-id="draw">
              <h2 class="wizard-step-title">Draw Your Deck
                <button type="button" class="change-mode-btn" onclick="openWelcomeModal()" title="Change build mode">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="14" height="14">
                    <path d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.433a.75.75 0 000-1.5H4.598a.75.75 0 00-.75.75v3.634a.75.75 0 001.5 0v-2.033l.312.311a7 7 0 0011.712-3.138.75.75 0 00-1.449-.39zm-11.073-3.96a.75.75 0 00.39 1.449 5.5 5.5 0 019.201-2.466l.312.311H12.71a.75.75 0 000 1.5h3.634a.75.75 0 00.75-.75V3.874a.75.75 0 00-1.5 0v2.033l-.312-.311A7 7 0 003.571 8.735.75.75 0 004.24 7.464z" />
                  </svg>
                  Change Mode
                </button>
              </h2>
              <div class="panel-content">

                <!-- Initial Instructions (hidden when shape is drawn) -->
                <div id="drawInstructionsPanel" class="draw-instructions-panel">
                  <p class="draw-instructions-text">Click on the canvas to draw a custom shape, enter dimensions below for a rectangle, or choose a template.</p>
                </div>

                <!-- Quick Rectangle Input (always visible until shape is drawn) -->
                <div id="quickDimensionsPanel" class="quick-dimensions-panel">
                  <div class="section-label">Quick Rectangle</div>
                  <div class="dimension-input-row">
                    <div class="dimension-field">
                      <label for="deckWidthInput">Width</label>
                      <div class="dimension-input-group">
                        <input type="number" id="deckWidthInput" min="4" max="100" value="16" step="1">
                        <span class="dimension-unit">ft</span>
                      </div>
                    </div>
                    <span class="dimension-separator">×</span>
                    <div class="dimension-field">
                      <label for="deckDepthInput">Depth</label>
                      <div class="dimension-input-group">
                        <input type="number" id="deckDepthInput" min="4" max="100" value="12" step="1">
                        <span class="dimension-unit">ft</span>
                      </div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-primary btn-full-width" onclick="createRectangleFromDimensions()">
                    Create Rectangle
                  </button>
                </div>

                <!-- Template Gallery (always visible until shape is drawn) -->
                <div id="templatePanel" class="template-gallery-panel">
                  <div class="section-label">Templates</div>
                  <div class="template-grid" id="templateGrid">
                    <button type="button" class="template-card" onclick="loadTemplate('square')" title="Square 12x12">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <rect x="15" y="5" width="30" height="30" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">Square</span>
                      <span class="template-size">12' × 12'</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('rectangle-12x16')" title="Rectangle 12x16">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <rect x="8" y="8" width="44" height="24" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">Rectangle</span>
                      <span class="template-size">12' × 16'</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('l-shape-left')" title="L-Shape (Left)">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M8 6 L8 34 L36 34 L36 20 L52 20 L52 6 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">L-Shape</span>
                      <span class="template-size">Left</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('l-shape-right')" title="L-Shape (Right)">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M8 6 L8 20 L24 20 L24 34 L52 34 L52 6 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">L-Shape</span>
                      <span class="template-size">Right</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('u-shape')" title="U-Shape Wrap">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M6 6 L6 34 L54 34 L54 6 L40 6 L40 22 L20 22 L20 6 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">U-Shape</span>
                      <span class="template-size">Wrap</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('notched')" title="Notched Corner (Right)">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M8 6 L8 34 L52 34 L52 18 L36 18 L36 6 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">Notched</span>
                      <span class="template-size">Right</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('notched-left')" title="Notched Corner (Left)">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M24 6 L24 18 L8 18 L8 34 L52 34 L52 6 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">Notched</span>
                      <span class="template-size">Left</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('diagonal-corners')" title="Chamfered Corners">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M15 6 L45 6 L52 13 L52 34 L8 34 L8 13 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">Chamfered</span>
                      <span class="template-size">Clipped Corners</span>
                    </button>
                    <button type="button" class="template-card" onclick="loadTemplate('bay-window')" title="Bay Window Bump-out">
                      <div class="template-preview">
                        <svg viewBox="0 0 60 40" class="template-svg">
                          <path d="M8 6 L52 6 L52 28 L40 28 L37 24 L23 24 L20 28 L8 28 Z" fill="none" stroke="currentColor" stroke-width="2"/>
                        </svg>
                      </div>
                      <span class="template-label">Bay Window</span>
                      <span class="template-size">Bump-out</span>
                    </button>
                  </div>
                </div>

                <!-- Add Another Tier Button (shown after first shape is closed) -->
                <div id="addTierContainer" class="add-tier-container hidden">
                  <button type="button" id="addTierBtn" class="btn btn-secondary btn-full-width" onclick="addAnotherTier()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                      <path d="M12 5v14M5 12h14"/>
                    </svg>
                    <span>Add Another Tier</span>
                  </button>
                </div>

                <!-- Tier Selection Tabs (shown when multiple tiers have points) -->
                <div id="tierControls" class="tier-controls hidden">
                  <div class="tier-tabs">
                    <button type="button" id="upperTierTab" class="tier-tab active" onclick="switchActiveTier('upper')">
                      <span class="tier-tab-dot" style="background: #4A90E2"></span>
                      Upper Tier
                    </button>
                    <button type="button" id="lowerTierTab" class="tier-tab" onclick="switchActiveTier('lower')">
                      <span class="tier-tab-dot" style="background: #10B981"></span>
                      Lower Tier
                    </button>
                  </div>
                  <div class="tier-info">
                    <span id="activeTierLabel">Editing: Upper Tier</span>
                  </div>
                </div>

                <!-- Edit Shape Panel (shown when shape is closed) -->
                <div id="editShapePanel" class="edit-shape-panel hidden">
                  <button type="button" id="editShapeBtn" class="btn btn-secondary btn-full-width edit-shape-btn" onclick="toggleShapeEditMode()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    <span>Edit Shape</span>
                  </button>
                  <p id="editShapeHint" class="edit-shape-hint hidden">Drag corners to move • Drag edges to resize • Click <span class="icon-hint">+</span> to add point • Click <span class="icon-hint">×</span> to remove</p>
                </div>

                <!-- Wall Selection (shown when shape is closed and needs wall selection) -->
                <div id="drawStepWallSelection" class="wall-selection-inline hidden">
                  <div class="instruction-box instruction-box-highlight">
                    <div class="instruction-header">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="instruction-icon">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                        <polyline points="10 17 15 12 10 7"/>
                        <line x1="15" y1="12" x2="3" y2="12"/>
                      </svg>
                      <span class="instruction-title">Select Wall</span>
                    </div>
                    <p>Click wall edge(s) that will be attached to your house. You can select multiple parallel walls.</p>
                  </div>
                </div>

                <!-- Next Button for Step 1 -->
                <div class="wizard-step-actions">
                  <button type="button" id="wizardNextBtn" class="btn btn-primary btn-full-width wizard-next-btn" onclick="goToNextStep()" disabled>
                    <span>Next: Structure</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 2: Structure & Height -->
            <div id="wizard-step-structure" class="wizard-step-content hidden" data-step-id="structure">
              <h2 class="wizard-step-title">Structure & Height</h2>

              <!-- Tier Selection Tabs (shown in multi-tier mode) -->
              <div id="structureTierControls" class="tier-controls hidden">
                <div class="tier-tabs">
                  <button type="button" id="structureUpperTierTab" class="tier-tab active" onclick="switchActiveTier('upper')">
                    <span class="tier-tab-dot" style="background: #4A90E2"></span>
                    Upper Tier
                  </button>
                  <button type="button" id="structureLowerTierTab" class="tier-tab" onclick="switchActiveTier('lower')">
                    <span class="tier-tab-dot" style="background: #10B981"></span>
                    Lower Tier
                  </button>
                </div>
                <p class="tier-height-hint" id="activeTierHeightLabel">Configure height for the selected tier</p>
              </div>

              <!-- Sub-step indicator (legacy, hidden - replaced by collapsed sections) -->
              <div class="substep-indicator" style="display:none;">
                <button type="button" class="substep-dot active" data-substep="1" onclick="setStructureSubstep(1)">
                  <span class="substep-num">1</span>
                  <span class="substep-label">Foundation</span>
                </button>
                <div class="substep-connector"></div>
                <button type="button" class="substep-dot" data-substep="2" onclick="setStructureSubstep(2)">
                  <span class="substep-num">2</span>
                  <span class="substep-label">Framing</span>
                </button>
                <div class="substep-connector"></div>
                <button type="button" class="substep-dot" data-substep="3" onclick="setStructureSubstep(3)">
                  <span class="substep-num">3</span>
                  <span class="substep-label">Finishing</span>
                </button>
              </div>

              <div class="panel-content">
                <div class="deck-specifications">
                  <form id="deckSpecsForm" class="space-y-4">
                  <div class="framing-config">

                    <!-- Height Section (collapsed by default) -->
                    <div class="config-section" data-section="height">
                      <div class="config-section-header">
                        <span class="config-section-label">Deck Height</span>
                        <span class="config-section-value" id="configHeightValue">4' 0"</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('height')"><svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg></button>
                      </div>
                      <div class="config-section-body">

                    <!-- Deck Height Input -->
                    <div class="deck-height-input">
                      <div class="visual-selector-label">
                        Deck Height
                      </div>
                      <div class="height-input-group">
                        <div class="height-input-field">
                          <select
                            id="deckHeightFeet"
                            name="deckHeightFeet"
                            class="height-select"
                            aria-label="Deck height in feet"
                          >
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                          </select>
                          <span class="height-unit">ft</span>
                        </div>
                        <div class="height-input-field">
                          <select
                            id="deckHeightInchesInput"
                            name="deckHeightInchesInput"
                            class="height-select"
                            aria-label="Deck height in inches"
                          >
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                          </select>
                          <span class="height-unit">in</span>
                        </div>
                      </div>
                    </div>
                      </div><!-- end config-section-body for height -->
                    </div><!-- end config-section height -->

                    <!-- Footing Type Section (collapsible) -->
                    <div class="config-section" data-section="footingType">
                      <div class="config-section-header">
                        <span class="config-section-label">Footing Type</span>
                        <span class="config-section-value" id="configFootingTypeValue">GH Levellers</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('footingType')" aria-label="Toggle footing type options"><svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg></button>
                      </div>
                      <div class="config-section-body">
                    <div class="visual-selector compact" data-selector="footingType">
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="gh_levellers">
                          <div class="visual-option-icon">
                            <img src="icons/footing_gh_leveller.png" alt="GH Levellers" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">GH Levellers</div>
                          <div class="visual-option-desc">+ 16x16 Slab</div>
                        </div>
                        <div class="visual-option" data-value="pylex">
                          <div class="visual-option-icon">
                            <img src="icons/footing_pylex.png" alt="Pylex Screw Piles" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Pylex</div>
                          <div class="visual-option-desc">50" Screw Piles</div>
                        </div>
                        <div class="visual-option" data-value="helical">
                          <div class="visual-option-icon">
                            <img src="icons/footing_helical.png" alt="Helical Piles" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Helical</div>
                          <div class="visual-option-desc">10' Piles</div>
                        </div>
                      </div>
                      <select id="footingType" name="footingType" class="hidden-select" aria-label="Footing type">
                        <option value="gh_levellers" selected>GH Levellers + 16x16 Slab</option>
                        <option value="pylex">Pylex 50" Screw Piles</option>
                        <option value="helical">10' Helical Piles</option>
                      </select>
                    </div>
                      </div>
                    </div><!-- end config-section footingType -->

                    <!-- Post Size Section (collapsible) -->
                    <div class="config-section" data-section="postSize">
                      <div class="config-section-header">
                        <span class="config-section-label">Post Size</span>
                        <span class="config-section-value" id="configPostSizeValue">Auto</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('postSize')" aria-label="Toggle post size options"><svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg></button>
                      </div>
                      <div class="config-section-body">
                    <div class="visual-selector compact" data-selector="postSize">
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="auto">
                          <div class="visual-option-icon">
                            <img src="icons/post_auto.png" alt="Auto" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Auto</div>
                          <div class="visual-option-desc">App Decides</div>
                        </div>
                        <div class="visual-option" data-value="4x4">
                          <div class="visual-option-icon">
                            <img src="icons/post_4x4.png" alt="4x4 Post" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">4x4</div>
                          <div class="visual-option-desc">2-ply beams</div>
                        </div>
                        <div class="visual-option" data-value="6x6">
                          <div class="visual-option-icon">
                            <img src="icons/post_6x6.png" alt="6x6 Post" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">6x6</div>
                          <div class="visual-option-desc">3-ply beams</div>
                        </div>
                      </div>
                      <select id="postSize" name="postSize" class="hidden-select" aria-label="Post size">
                        <option value="auto" selected>App Decides</option>
                        <option value="4x4">4x4 Posts (2-ply beams)</option>
                        <option value="6x6">6x6 Posts (3-ply beams)</option>
                      </select>
                    </div>
                      </div>
                    </div><!-- end config-section postSize -->

                    <!-- All sub-steps shown inline (collapsed sections replace sub-step navigation) -->
                    <div id="structure-substep-1" class="structure-substep active" data-substep="1" style="display:none;">
                      <!-- Foundation content moved to config-sections above -->
                    </div>

                    <div id="structure-substep-2" class="structure-substep active" data-substep="2">

                    <!-- Joists Section (collapsible) -->
                    <div class="config-section" data-section="joists">
                      <div class="config-section-header">
                        <span class="config-section-label">Joists</span>
                        <span class="config-section-value" id="configJoistsValue">16" OC</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('joists')"><svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg></button>
                      </div>
                      <div class="config-section-body">
                    <!-- Joist Spacing Visual Selector -->
                    <div class="visual-selector compact" data-selector="joistSpacing">
                      <div class="visual-selector-label">
                        Joist Spacing
                      </div>
                      <div class="visual-selector-grid two-col">
                        <div class="visual-option selected" data-value="16">
                          <div class="visual-option-icon">
                            <img src="icons/joist_16oc.png" alt="16 inch OC" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">16" OC</div>
                          <div class="visual-option-desc">Standard</div>
                        </div>
                        <div class="visual-option" data-value="12">
                          <div class="visual-option-icon">
                            <img src="icons/joist_12oc.png" alt="12 inch OC" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">12" OC</div>
                          <div class="visual-option-desc">Heavy Duty</div>
                        </div>
                      </div>
                      <select id="joistSpacing" name="joistSpacing" class="hidden-select" aria-label="Joist spacing">
                        <option value="16" selected>16" OC</option>
                        <option value="12">12" OC</option>
                      </select>
                    </div>
                      </div><!-- end config-section-body for joists -->
                    </div><!-- end config-section joists -->

                    <!-- Attachment Section (collapsible) -->
                    <div class="config-section" data-section="ledger">
                      <div class="config-section-header">
                        <span class="config-section-label">Attachment</span>
                        <span class="config-section-value" id="configLedgerValue">House Rim</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('ledger')"><svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg></button>
                      </div>
                      <div class="config-section-body">
                    <!-- Attachment Type Visual Selector -->
                    <div class="visual-selector compact" data-selector="attachmentType">
                      <div class="visual-selector-label">
                        Attachment Type
                      </div>
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="house_rim">
                          <div class="visual-option-icon">
                            <img src="icons/attach_ledger.png" alt="Ledger" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Ledger</div>
                          <div class="visual-option-desc">House Rim</div>
                        </div>
                        <div class="visual-option" data-value="concrete">
                          <div class="visual-option-icon">
                            <img src="icons/attach_concrete.png" alt="Concrete Foundation" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Concrete</div>
                          <div class="visual-option-desc">Foundation</div>
                        </div>
                        <div class="visual-option" data-value="floating">
                          <div class="visual-option-icon">
                            <img src="icons/attach_floating.png" alt="Floating" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Floating</div>
                          <div class="visual-option-desc">Freestanding</div>
                        </div>
                      </div>
                      <select id="attachmentType" name="attachmentType" class="hidden-select" aria-label="Attachment type">
                        <option value="house_rim" selected>House Rim (Ledger)</option>
                        <option value="concrete">Concrete Foundation</option>
                        <option value="floating">Floating</option>
                      </select>
                    </div>
                      </div><!-- end config-section-body for ledger -->
                    </div><!-- end config-section ledger -->

                    <!-- Beams Section (collapsible) -->
                    <div class="config-section" data-section="beams">
                      <div class="config-section-header">
                        <span class="config-section-label">Beam Type</span>
                        <span class="config-section-value" id="configBeamsValue">Drop Beam</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('beams')"><svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg></button>
                      </div>
                      <div class="config-section-body">
                    <!-- Beam Type Visual Selector -->
                    <div class="visual-selector compact" data-selector="beamType">
                      <div class="visual-selector-label">
                        Beam Type
                      </div>
                      <div class="visual-selector-grid two-col">
                        <div class="visual-option selected" data-value="drop">
                          <div class="visual-option-icon">
                            <img src="icons/beam_drop.png" alt="Drop Beam" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Drop Beam</div>
                          <div class="visual-option-desc">Below joists</div>
                        </div>
                        <div class="visual-option" data-value="flush">
                          <div class="visual-option-icon">
                            <img src="icons/beam_flush.png" alt="Flush Beam" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Flush Beam</div>
                          <div class="visual-option-desc">Level with joists</div>
                        </div>
                      </div>
                      <select id="beamType" name="beamType" class="hidden-select" aria-label="Beam type">
                        <option value="drop" selected>Drop Beam</option>
                        <option value="flush">Flush Beam</option>
                      </select>
                    </div>
                      </div><!-- end config-section-body for beams -->
                    </div><!-- end config-section beams -->

                    </div><!-- End Sub-step 2: Framing -->

                    <!-- Sub-step 3: Finishing -->
                    <div id="structure-substep-3" class="structure-substep active" data-substep="3">

                    <!-- Picture Frame Section (collapsible) -->
                    <div class="config-section" data-section="pictureFrame">
                      <div class="config-section-header">
                        <span class="config-section-label">Picture Frame</span>
                        <span class="config-section-value" id="configPictureFrameValue">None</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('pictureFrame')" aria-label="Toggle picture frame options">
                          <svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                        </button>
                      </div>
                      <div class="config-section-body">
                    <div class="visual-selector compact" data-selector="pictureFrame">
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="none">
                          <div class="visual-option-icon">
                            <img src="icons/pf_none.png" alt="No Picture Frame" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">None</div>
                        </div>
                        <div class="visual-option" data-value="single">
                          <div class="visual-option-icon">
                            <img src="icons/pf_single.png" alt="Single Picture Frame" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Single</div>
                        </div>
                        <div class="visual-option" data-value="double">
                          <div class="visual-option-icon">
                            <img src="icons/pf_double.png" alt="Double Picture Frame" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Double</div>
                        </div>
                      </div>
                      <select id="pictureFrame" name="pictureFrame" class="hidden-select" aria-label="Picture frame border">
                        <option value="none" selected>None</option>
                        <option value="single">Single</option>
                        <option value="double">Double</option>
                      </select>
                    </div>
                      </div>
                    </div><!-- end config-section pictureFrame -->

                    <!-- Joist Protection Section (collapsible) -->
                    <div class="config-section" data-section="joistProtection">
                      <div class="config-section-header">
                        <span class="config-section-label">Joist Protection</span>
                        <span class="config-section-value" id="configJoistProtectionValue">None</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('joistProtection')" aria-label="Toggle joist protection options">
                          <svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                        </button>
                      </div>
                      <div class="config-section-body">
                    <div class="visual-selector compact" data-selector="joistProtection">
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="none">
                          <div class="visual-option-icon">
                            <img src="icons/jp_none.png" alt="No Protection" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">None</div>
                          <div class="visual-option-desc">Unprotected</div>
                        </div>
                        <div class="visual-option" data-value="gtape">
                          <div class="visual-option-icon">
                            <img src="icons/jp_gtape.png" alt="G-Tape" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">G-Tape</div>
                          <div class="visual-option-desc">Flashing Tape</div>
                        </div>
                        <div class="visual-option" data-value="coating">
                          <div class="visual-option-icon">
                            <img src="icons/jp_coating.png" alt="Coating" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Coating</div>
                          <div class="visual-option-desc">Liquid Applied</div>
                        </div>
                      </div>
                      <select id="joistProtection" name="joistProtection" class="hidden-select" aria-label="Joist protection">
                        <option value="none" selected>None</option>
                        <option value="gtape">G-Tape</option>
                        <option value="coating">Deck Coating</option>
                      </select>
                    </div>
                      </div>
                    </div><!-- end config-section joistProtection -->

                    <!-- Framing Fasteners Section (collapsible) -->
                    <div class="config-section" data-section="fasteners">
                      <div class="config-section-header">
                        <span class="config-section-label">Fasteners</span>
                        <span class="config-section-value" id="configFastenersValue">Screws</span>
                        <button type="button" class="config-change-btn" onclick="toggleConfigSection('fasteners')" aria-label="Toggle fastener options">
                          <svg class="config-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                        </button>
                      </div>
                      <div class="config-section-body">
                    <div class="visual-selector compact" data-selector="fasteners">
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="screws_3in">
                          <div class="visual-option-icon">
                            <img src="icons/fastener_screws.png" alt="Screws" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Screws</div>
                          <div class="visual-option-desc">3" Deck</div>
                        </div>
                        <div class="visual-option" data-value="u2_3_18">
                          <div class="visual-option-icon">
                            <img src="icons/fastener_u2.png" alt="U2 Structural" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">U2</div>
                          <div class="visual-option-desc">3-1/8" Structural</div>
                        </div>
                        <div class="visual-option" data-value="paslode_3_14">
                          <div class="visual-option-icon">
                            <img src="icons/fastener_paslode.png" alt="Paslode Nails" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Paslode</div>
                          <div class="visual-option-desc">3-1/4" Nails</div>
                        </div>
                      </div>
                      <select id="fasteners" name="fasteners" class="hidden-select" aria-label="Fastener type">
                        <option value="screws_3in" selected>3" Deck Screws</option>
                        <option value="u2_3_18">U2 3-1/8"</option>
                        <option value="paslode_3_14">Paslode 3-1/4"</option>
                      </select>
                    </div>
                      </div>
                    </div><!-- end config-section fasteners -->

                    </div><!-- end framing-config -->
                    </div><!-- End Sub-step 3: Finishing -->

                  </form>
                </div>

                <!-- Sub-step Navigation buttons (hidden - replaced by collapsed sections) -->
                <div class="substep-actions" style="display:none;">
                  <button type="button" class="btn btn-secondary substep-prev-btn" onclick="prevStructureSubstep()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                    </svg>
                    <span>Back</span>
                  </button>
                  <button type="button" class="btn btn-primary substep-next-btn" onclick="nextStructureSubstep()">
                    <span>Next</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>

                <!-- Navigation buttons for Step 2 -->
                <div class="wizard-step-actions">
                  <button type="button" class="btn btn-secondary wizard-prev-btn" onclick="goToPreviousStep()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                    </svg>
                    <span>Back</span>
                  </button>
                  <button type="button" class="btn btn-primary wizard-next-btn" onclick="goToNextStep()">
                    <span>Next: Stairs</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 3: Stairs -->
            <div id="wizard-step-stairs" class="wizard-step-content hidden" data-step-id="stairs">
              <h2 class="wizard-step-title">Add Stairs</h2>
              <div class="panel-content">
                <div class="stair-specs">
                  <form id="stairSpecsForm" class="space-y-4">
                    <div>
                      <label for="stairWidth" class="form-label">Stair Width</label>
                      <select id="stairWidth" name="stairWidth" class="form-select">
                        <option value="4">4' 0"</option>
                        <option value="5">5' 0"</option>
                        <option value="6">6' 0"</option>
                        <option value="7">7' 0"</option>
                        <option value="8">8' 0"</option>
                        <option value="9">9' 0"</option>
                        <option value="10">10' 0"</option>
                        <option value="11">11' 0"</option>
                        <option value="12">12' 0"</option>
                        <option value="13">13' 0"</option>
                        <option value="14">14' 0"</option>
                        <option value="15">15' 0"</option>
                        <option value="16">16' 0"</option>
                        <option value="17">17' 0"</option>
                        <option value="18">18' 0"</option>
                        <option value="19">19' 0"</option>
                        <option value="20">20' 0"</option>
                      </select>
                    </div>
                    <!-- Stringer Type Visual Selector -->
                    <div class="visual-selector compact" data-selector="stringerType">
                      <div class="visual-selector-label">Stringer Type</div>
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="pylex_steel">
                          <div class="visual-option-icon">
                            <img src="icons/stringer_pylex.png" alt="Pylex Steel" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Pylex Steel</div>
                          <div class="visual-option-desc">Pre-fab</div>
                        </div>
                        <div class="visual-option" data-value="lvl_wood">
                          <div class="visual-option-icon">
                            <img src="icons/stringer_lvl.png" alt="LVL Wood" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">LVL Wood</div>
                          <div class="visual-option-desc">Pre-fab</div>
                        </div>
                        <div class="visual-option" data-value="custom_2x12">
                          <div class="visual-option-icon">
                            <img src="icons/stringer_custom.png" alt="Custom 2x12" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Custom 2x12</div>
                          <div class="visual-option-desc">Site Cut</div>
                        </div>
                      </div>
                      <select id="stringerType" name="stringerType" class="hidden-select" aria-label="Stringer type">
                        <option value="pylex_steel" selected>Pylex Steel (Pre-fab)</option>
                        <option value="lvl_wood">LVL Wood (Pre-fab)</option>
                        <option value="custom_2x12">Custom Cut 2x12</option>
                      </select>
                    </div>
                    <!-- Landing Type Visual Selector -->
                    <div class="visual-selector compact" data-selector="landingType">
                      <div class="visual-selector-label">Landing Type</div>
                      <div class="visual-selector-grid three-col">
                        <div class="visual-option selected" data-value="existing">
                          <div class="visual-option-icon">
                            <img src="icons/landing_existing.png" alt="Existing Surface" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Existing</div>
                          <div class="visual-option-desc">Ground/Patio</div>
                        </div>
                        <div class="visual-option" data-value="slabs_16x16">
                          <div class="visual-option-icon">
                            <img src="icons/landing_slabs.png" alt="16x16 Slabs" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">16x16 Slabs</div>
                          <div class="visual-option-desc">Concrete Pads</div>
                        </div>
                        <div class="visual-option" data-value="concrete_pad">
                          <div class="visual-option-icon">
                            <img src="icons/landing_concrete.png" alt="Concrete Pad" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Concrete Pad</div>
                          <div class="visual-option-desc">Poured</div>
                        </div>
                      </div>
                      <select id="landingType" name="landingType" class="hidden-select" aria-label="Landing type">
                        <option value="existing" selected>Existing Surface (Ground/Patio)</option>
                        <option value="slabs_16x16">16"x16" Slabs</option>
                        <option value="concrete_pad">Poured Concrete Pad</option>
                      </select>
                    </div>
                    <!-- Stair Target (for multi-tier decks) -->
                    <div id="stairTargetContainer" class="visual-selector compact hidden" data-selector="stairTarget">
                      <div class="visual-selector-label">Stair Destination</div>
                      <div class="visual-selector-grid two-col">
                        <div class="visual-option selected" data-value="ground">
                          <div class="visual-option-icon">
                            <img src="icons/stair_ground.png" alt="Ground Level" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Ground</div>
                          <div class="visual-option-desc">To grade level</div>
                        </div>
                        <div class="visual-option" data-value="lower_tier">
                          <div class="visual-option-icon">
                            <img src="icons/stair_lower_tier.png" alt="Lower Tier" class="visual-option-img">
                          </div>
                          <div class="visual-option-name">Lower Tier</div>
                          <div class="visual-option-desc">Connect tiers</div>
                        </div>
                      </div>
                      <select id="stairTarget" name="stairTarget" class="hidden-select" aria-label="Stair destination">
                        <option value="ground" selected>Ground Level</option>
                        <option value="lower_tier">Lower Tier</option>
                      </select>
                    </div>
                  </form>
                </div>

                <!-- Placed stairs list -->
                <div id="wizardStairList" class="stair-list-section">
                  <div class="flex justify-between items-center mb-2 mt-4">
                    <span class="text-sm font-medium text-gray-700">Placed Stairs</span>
                    <span id="wizardStairCount" class="text-sm text-gray-500">0 sets</span>
                  </div>
                  <div id="wizardStairListItems" class="stair-list space-y-2">
                    <!-- Dynamically populated -->
                  </div>
                </div>

                <!-- Navigation buttons for Step 3 -->
                <div class="wizard-step-actions">
                  <button type="button" class="btn btn-secondary wizard-prev-btn" onclick="goToPreviousStep()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                    </svg>
                    <span>Back</span>
                  </button>
                  <button type="button" class="btn btn-primary wizard-next-btn" onclick="goToNextStep()">
                    <span>Next: Decking</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 4: Decking -->
            <div id="wizard-step-decking" class="wizard-step-content hidden" data-step-id="decking">
              <h2 class="wizard-step-title">Decking Materials</h2>
              <div class="panel-content">

                <!-- Decking Material Type -->
                <div class="visual-selector compact" data-selector="deckingMaterial">
                  <div class="visual-selector-label">Material Type</div>
                  <div class="visual-selector-grid two-col">
                    <div class="visual-option selected" data-value="pt">
                      <div class="visual-option-icon">
                        <img src="icons/decking_pt.png" alt="Pressure Treated" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">Pressure Treated</div>
                      <div class="visual-option-desc">5/4x6 Brown</div>
                    </div>
                    <div class="visual-option" data-value="cedar">
                      <div class="visual-option-icon">
                        <img src="icons/decking_cedar.png" alt="Cedar" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">Cedar</div>
                      <div class="visual-option-desc">Natural wood</div>
                    </div>
                  </div>
                  <select id="deckingMaterial" name="deckingMaterial" class="hidden-select" aria-label="Decking material">
                    <option value="pt" selected>Pressure Treated</option>
                    <option value="cedar">Cedar</option>
                  </select>
                </div>

                <!-- Board Size (Cedar only shows 5/4x5 option) -->
                <div id="cedarSizeSelector" class="visual-selector compact hidden" data-selector="cedarBoardSize">
                  <div class="visual-selector-label">Board Width</div>
                  <div class="visual-selector-grid two-col">
                    <div class="visual-option selected" data-value="5.5">
                      <div class="visual-option-icon">
                        <img src="icons/cedar_5x6.png" alt="5/4 x 6" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">5/4 x 6</div>
                      <div class="visual-option-desc">5½" wide</div>
                    </div>
                    <div class="visual-option" data-value="4.5">
                      <div class="visual-option-icon">
                        <img src="icons/cedar_5x5.png" alt="5/4 x 5" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">5/4 x 5</div>
                      <div class="visual-option-desc">4½" wide</div>
                    </div>
                  </div>
                  <select id="cedarBoardSize" name="cedarBoardSize" class="hidden-select" aria-label="Cedar board size">
                    <option value="5.5" selected>5/4 x 6 (5½" wide)</option>
                    <option value="4.5">5/4 x 5 (4½" wide)</option>
                  </select>
                </div>

                <!-- Board Direction -->
                <div class="visual-selector compact" data-selector="boardDirection">
                  <div class="visual-selector-label">Board Direction</div>
                  <div class="visual-selector-grid two-col">
                    <div class="visual-option selected" data-value="horizontal">
                      <div class="visual-option-icon">
                        <img src="icons/board_horizontal.png" alt="Horizontal" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">Horizontal</div>
                      <div class="visual-option-desc">Standard layout</div>
                    </div>
                    <div class="visual-option" data-value="diagonal">
                      <div class="visual-option-icon">
                        <img src="icons/board_diagonal.png" alt="Diagonal" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">Diagonal</div>
                      <div class="visual-option-desc">45° angle (+15% material)</div>
                    </div>
                  </div>
                  <select id="boardDirection" name="boardDirection" class="hidden-select" aria-label="Board direction">
                    <option value="horizontal" selected>Horizontal</option>
                    <option value="diagonal">Diagonal (45°)</option>
                  </select>
                </div>

                <!-- Picture Frame Preview (synced with Structure step) -->
                <div class="visual-selector compact" data-selector="deckingPictureFrame">
                  <div class="visual-selector-label">Picture Frame Border</div>
                  <div class="visual-selector-grid three-col">
                    <div class="visual-option selected" data-value="none">
                      <div class="visual-option-icon">
                        <img src="icons/pf_none.png" alt="No Picture Frame" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">None</div>
                    </div>
                    <div class="visual-option" data-value="single">
                      <div class="visual-option-icon">
                        <img src="icons/pf_single.png" alt="Single Picture Frame" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">Single</div>
                    </div>
                    <div class="visual-option" data-value="double">
                      <div class="visual-option-icon">
                        <img src="icons/pf_double.png" alt="Double Picture Frame" class="visual-option-img">
                      </div>
                      <div class="visual-option-name">Double</div>
                    </div>
                  </div>
                  <select id="deckingPictureFrame" name="deckingPictureFrame" class="hidden-select" aria-label="Picture frame border">
                    <option value="none" selected>None</option>
                    <option value="single">Single</option>
                    <option value="double">Double</option>
                  </select>
                </div>

                <!-- Breaker Boards Section -->
                <div class="breaker-boards-section">
                  <div class="visual-selector-label">
                    Breaker Boards
                    <span class="label-hint">(Seam boards to avoid butt joints)</span>
                  </div>

                  <div id="breakerBoardInfo" class="breaker-board-info">
                    <div class="breaker-suggestion" id="breakerSuggestion">
                      <!-- Populated by JS based on deck dimensions -->
                    </div>
                  </div>

                  <div id="breakerBoardsList" class="breaker-boards-list">
                    <!-- Breaker boards will be listed here -->
                  </div>

                  <button type="button" id="addBreakerBtn" class="btn btn-secondary btn-sm" onclick="enterBreakerPlacementMode()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                    </svg>
                    <span>Add Breaker Board</span>
                  </button>
                </div>

                <!-- Decking Summary -->
                <div class="decking-summary" id="deckingSummary">
                  <div class="summary-label">Estimated Boards</div>
                  <div class="summary-value" id="deckingBoardCount">--</div>
                </div>

                <!-- Navigation buttons for Step 4 -->
                <div class="wizard-step-actions">
                  <button type="button" class="btn btn-secondary wizard-prev-btn" onclick="goToPreviousStep()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                    </svg>
                    <span>Back</span>
                  </button>
                  <button type="button" class="btn btn-primary wizard-next-btn" onclick="goToNextStep()">
                    <span>Next: Railing</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 5: Railing (Coming Soon) -->
            <div id="wizard-step-railing" class="wizard-step-content hidden" data-step-id="railing">
              <h2 class="wizard-step-title">Railing Options</h2>
              <div class="panel-content">
                <p class="text-muted text-center py-8">Railing options coming soon</p>

                <!-- Navigation buttons for Step 5 -->
                <div class="wizard-step-actions">
                  <button type="button" class="btn btn-secondary wizard-prev-btn" onclick="goToPreviousStep()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                    </svg>
                    <span>Back</span>
                  </button>
                  <button type="button" class="btn btn-primary wizard-next-btn" onclick="goToNextStep()">
                    <span>Next: Review</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 6: Review & Save -->
            <div id="wizard-step-review" class="wizard-step-content hidden" data-step-id="review">
              <h2 class="wizard-step-title">Review & Save</h2>
              <div class="panel-content">
                <!-- Quick Specs summary -->
                <div id="reviewSummarySection">
                  <h3 class="text-base font-semibold mb-2 text-[#333333]">
                    Specifications Summary
                  </h3>
                  <dl id="reviewSummaryList" class="summary-list text-sm"></dl>

                  <!-- View Full Specifications Button -->
                  <button type="button" id="reviewViewSpecsBtn" class="view-specs-btn" onclick="openSpecsModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M16.403 12.652a3 3 0 000-5.304 3 3 0 00-3.75-3.751 3 3 0 00-5.305 0 3 3 0 00-3.751 3.75 3 3 0 000 5.305 3 3 0 003.75 3.751 3 3 0 005.305 0 3 3 0 003.751-3.75zm-2.546-4.46a.75.75 0 00-1.214-.883l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                    </svg>
                    View Full Specifications
                    <span class="permit-badge-small">Permit-Ready</span>
                  </button>
                </div>

                <!-- Stairs summary -->
                <div id="reviewStairsSection" class="mt-4">
                  <div class="flex justify-between items-center mb-2">
                    <h3 class="text-base font-semibold text-[#333333]">Stairs</h3>
                    <span id="reviewStairCount" class="text-sm text-gray-500">0 sets</span>
                  </div>
                  <div id="reviewStairList" class="stair-list space-y-1 text-sm">
                    <p class="text-gray-500">No stairs added</p>
                  </div>
                </div>

                <!-- Layer Toggle Legend -->
                <div id="layerTogglesPanel" class="layer-toggles">
                  <h4 class="layer-toggles-title">Visible Layers</h4>
                  <label class="layer-toggle" data-layer-toggle="outline">
                    <input type="checkbox" checked data-layer="outline" onchange="toggleLayer('outline')"> Outline &amp; Dimensions
                  </label>
                  <label class="layer-toggle" data-layer-toggle="framing">
                    <input type="checkbox" checked data-layer="framing" onchange="toggleLayer('framing')"> Framing
                  </label>
                  <label class="layer-toggle" data-layer-toggle="decking">
                    <input type="checkbox" checked data-layer="decking" onchange="toggleLayer('decking')"> Decking
                  </label>
                  <label class="layer-toggle" data-layer-toggle="railing">
                    <input type="checkbox" checked data-layer="railing" onchange="toggleLayer('railing')"> Railing
                  </label>
                  <label class="layer-toggle" data-layer-toggle="stairs">
                    <input type="checkbox" checked data-layer="stairs" onchange="toggleLayer('stairs')"> Stairs
                  </label>
                </div>

                <!-- Edit buttons to jump to steps -->
                <div class="review-edit-links mt-4">
                  <button type="button" class="review-edit-btn" onclick="setWizardStep('draw')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                    </svg>
                    Edit Shape
                  </button>
                  <button type="button" class="review-edit-btn" onclick="setWizardStep('structure')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                    </svg>
                    Edit Structure
                  </button>
                  <button type="button" class="review-edit-btn" onclick="setWizardStep('stairs')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                    </svg>
                    Edit Stairs
                  </button>
                </div>

                <!-- Save/Export Actions -->
                <div class="review-actions mt-6">
                  <button type="button" class="btn btn-primary btn-full-width mb-2" onclick="openProjectsModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                      <path d="M2 4.75C2 3.784 2.784 3 3.75 3h4.836c.464 0 .909.184 1.237.513l1.414 1.414a.25.25 0 00.177.073h4.836c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0116.25 17H3.75A1.75 1.75 0 012 15.25V4.75z" />
                    </svg>
                    Save Project
                  </button>
                  <button type="button" class="btn btn-secondary btn-full-width" onclick="exportToPDF()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                      <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" />
                    </svg>
                    Export PDF
                  </button>
                </div>

                <!-- Navigation buttons for Step 6 -->
                <div class="wizard-step-actions">
                  <button type="button" class="btn btn-secondary wizard-prev-btn" onclick="goToPreviousStep()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                      <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
                    </svg>
                    <span>Back</span>
                  </button>
                </div>
              </div>
            </div>

            </div> <!-- End wizard-content -->
          </div> <!-- End wizard-panel -->
            </div> <!-- End input-panel -->

            <div id="main-content-panel">
              <div class="info-card">
                <div
                  id="canvasContainerWrapper"
                  class="relative"
                >
                  <div id="dimensionInputContainer" class="flex items-center mb-2 hidden">
                    <label class="text-sm text-gray-600 mr-2">Enter length:</label>
                    <div class="flex flex-1 gap-2">
                      <input id="dimensionFeetInput" type="number" min="0" class="form-input text-sm py-1 px-2 w-16" placeholder="ft" aria-label="Length in feet">
                      <input id="dimensionInchesInput" type="number" min="0" max="11" class="form-input text-sm py-1 px-2 w-16" placeholder="in" aria-label="Length in inches">
                    </div>
                    <button id="applyDimensionBtn" class="btn btn-secondary text-xs px-3 py-1 leading-tight ml-2">Apply</button>
                    <button id="cancelDimensionBtn" class="btn btn-secondary text-xs px-3 py-1 leading-tight ml-2">Cancel</button>
                  </div>
                  <div id="canvasContainer" class="relative">
                    <canvas id="deckCanvas"></canvas>

                    <!-- 3D Viewer Container (hidden by default) -->
                    <div id="viewer3DContainer" class="viewer-3d-container hidden">
                      <!-- Three.js canvas will be inserted here -->
                      <div class="viewer-3d-info">
                        <kbd>Drag</kbd> to rotate &nbsp;|&nbsp; <kbd>Scroll</kbd> to zoom &nbsp;|&nbsp; <kbd>Right-drag</kbd> to pan
                      </div>
                    </div>

                    <!-- 3D View Controls removed - 3D Preview modal is accessed from toolbar -->

                    <!-- Grid scale indicator -->
                    <div class="grid-scale-indicator">
                      <div class="scale-bar"></div>
                      <span class="scale-label">1 ft</span>
                    </div>

                    <!-- Floating control buttons (bottom center) -->
                    <div class="floating-controls">
                      <button
                        type="button"
                        id="undoBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg btn-disabled"
                        title="Undo (Ctrl+Z)"
                        onclick="undo()"
                        disabled
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M7.793 2.232a.75.75 0 01-.025 1.06L3.622 7.25h10.003a5.375 5.375 0 010 10.75H10.75a.75.75 0 010-1.5h2.875a3.875 3.875 0 000-7.75H3.622l4.146 3.957a.75.75 0 01-1.036 1.085l-5.5-5.25a.75.75 0 010-1.085l5.5-5.25a.75.75 0 011.06.025z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <button
                        type="button"
                        id="redoBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg btn-disabled"
                        title="Redo (Ctrl+Y)"
                        onclick="redo()"
                        disabled
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M12.207 2.232a.75.75 0 00.025 1.06l4.146 3.958H6.375a5.375 5.375 0 000 10.75H9.25a.75.75 0 000-1.5H6.375a3.875 3.875 0 010-7.75h10.003l-4.146 3.957a.75.75 0 001.036 1.085l5.5-5.25a.75.75 0 000-1.085l-5.5-5.25a.75.75 0 00-1.06.025z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <div class="floating-controls-divider"></div>
                      <button
                        type="button"
                        id="zoomInBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Zoom In"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          class="w-5 h-5"
                        >
                          <path
                            d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z"
                          />
                        </svg>
                      </button>
                      <button
                        type="button"
                        id="zoomOutBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Zoom Out"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          class="w-5 h-5"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M4 10a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H4.75A.75.75 0 0 1 4 10Z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </button>
                      <button
                        type="button"
                        id="centerFitBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Center & Fit"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="w-5 h-5"
                        >
                          <path d="M2 3h6v6H2z"/>
                          <path d="M16 3h6v6h-6z"/>
                          <path d="M16 15h6v6h-6z"/>
                          <path d="M2 15h6v6H2z"/>
                        </svg>
                      </button>
                      <button
                        id="blueprintToggleBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Blueprint View"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" />
                          <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.186A10.004 10.004 0 0110 3c4.257 0 7.893 2.66 9.336 6.41.147.381.146.804 0 1.186A10.004 10.004 0 0110 17c-4.257 0-7.893-2.66-9.336-6.41zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <button
                        id="measureToolBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Measure Distance"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M2 4.25A2.25 2.25 0 014.25 2h11.5A2.25 2.25 0 0118 4.25v2a.75.75 0 01-1.5 0V5.56l-1.22 1.22v1.97a.75.75 0 01-1.5 0v-.72l-1.5 1.5v1.72a.75.75 0 01-1.5 0v-.47L9.28 11.28v1.97a.75.75 0 01-1.5 0v-.72l-1.5 1.5v1.72a.75.75 0 01-1.5 0v-.47L2 17.06v-2.81a.75.75 0 011.5 0v.25l1.22-1.22V11.5a.75.75 0 011.5 0v.72l1.5-1.5V8.75a.75.75 0 011.5 0v.97l1.5-1.5V6.25a.75.75 0 011.5 0v.72l1.5-1.5V4.25a.75.75 0 00-.75-.75H4.25a.75.75 0 00-.75.75v1.5a.75.75 0 01-1.5 0v-1.5z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <button
                        id="cutListModeBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Cut List Labels"
                        onclick="toggleCutListMode()"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm4.75 6.5a.75.75 0 00-1.5 0v2.25H5.5a.75.75 0 000 1.5h2.25v2.25a.75.75 0 001.5 0v-2.25h2.25a.75.75 0 000-1.5H9.25V8.5z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <button
                        id="preview3DBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="3D Preview"
                        onclick="open3DPreview()"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" />
                        </svg>
                      </button>
                      <button
                        id="clearCanvasBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Clear Canvas"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <div class="floating-controls-divider"></div>
                      <button
                        id="projectsBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Save/Load Projects"
                        onclick="openProjectsModal()"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path d="M2 4.75C2 3.784 2.784 3 3.75 3h4.836c.464 0 .909.184 1.237.513l1.414 1.414a.25.25 0 00.177.073h4.836c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0116.25 17H3.75A1.75 1.75 0 012 15.25V4.75z" />
                        </svg>
                      </button>
                      <button
                        id="exportPdfBtn"
                        class="btn btn-secondary text-xs px-3 py-2 leading-tight shadow-lg"
                        title="Export PDF"
                        onclick="exportToPDF()"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </div>

                    <!-- Dev Tools (floating right side) -->
                    <div class="dev-tools-float">
                      <button
                        id="toggleDecompositionBtn"
                        class="dev-tool-btn"
                        title="Show Sections (Dev)"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                          <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h9.5A2.25 2.25 0 0117 4.25v2.5A2.25 2.25 0 0114.75 9h-9.5A2.25 2.25 0 013 6.75v-2.5zm2.25-.75a.75.75 0 00-.75.75v2.5c0 .414.336.75.75.75h9.5a.75.75 0 00.75-.75v-2.5a.75.75 0 00-.75-.75h-9.5z" clip-rule="evenodd" />
                          <path fill-rule="evenodd" d="M3 13.25A2.25 2.25 0 015.25 11h9.5A2.25 2.25 0 0117 13.25v2.5A2.25 2.25 0 0114.75 18h-9.5A2.25 2.25 0 013 15.75v-2.5zm2.25-.75a.75.75 0 00-.75.75v2.5c0 .414.336.75.75.75h9.5a.75.75 0 00.75-.75v-2.5a.75.75 0 00-.75-.75h-9.5z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </div>

                    <!-- Floating Legend -->
                    <div class="floating-legend" id="floatingLegend">
                      <button class="floating-legend-toggle" onclick="document.getElementById('floatingLegend').classList.toggle('expanded')" title="Toggle Legend">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                          <path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z" clip-rule="evenodd" />
                        </svg>
                        <span>Legend</span>
                      </button>
                      <div class="floating-legend-content">
                        <div class="legend-header">
                          <span>Show/Hide Layers</span>
                          <div class="legend-actions">
                            <button type="button" class="legend-action-btn" onclick="toggleAllLayers(true)" title="Show All">All</button>
                            <button type="button" class="legend-action-btn" onclick="toggleAllLayers(false)" title="Hide All">None</button>
                          </div>
                        </div>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-outline" checked onchange="toggleLayerVisibility('outline')">
                          <span class="legend-color" style="background-color: #4A90E2;"></span>
                          <span class="legend-label">Outline</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-dimensions" checked onchange="toggleLayerVisibility('dimensions')">
                          <span class="legend-color" style="background-color: #333333;"></span>
                          <span class="legend-label">Dimensions</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-ledger" checked onchange="toggleLayerVisibility('ledger')">
                          <span class="legend-color" style="background-color: #f97316;"></span>
                          <span class="legend-label">Ledger</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-joists" checked onchange="toggleLayerVisibility('joists')">
                          <span class="legend-color" style="background-color: #374151;"></span>
                          <span class="legend-label">Joists/Rim</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-beams" checked onchange="toggleLayerVisibility('beams')">
                          <span class="legend-color" style="background-color: #dc2626;"></span>
                          <span class="legend-label">Beams</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-posts" checked onchange="toggleLayerVisibility('posts')">
                          <span class="legend-color legend-color-post"></span>
                          <span class="legend-label">Posts/Footings</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-blocking" checked onchange="toggleLayerVisibility('blocking')">
                          <span class="legend-color" style="background-color: #8B5CF6;"></span>
                          <span class="legend-label">Blocking</span>
                        </label>
                        <label class="legend-row legend-toggle">
                          <input type="checkbox" id="layer-stairs" checked onchange="toggleLayerVisibility('stairs')">
                          <span class="legend-color" style="background-color: #7c3aed;"></span>
                          <span class="legend-label">Stairs</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

                <!-- Running Total Bar (shown during Structure/Decking/Railing steps) -->
                <div id="runningTotalBar" class="running-total-bar hidden">
                  <span class="running-total-label">Estimated Total:</span>
                  <span class="running-total-categories" id="runningTotalCategories">
                    <!-- Populated by JavaScript -->
                  </span>
                  <span class="running-total-grand" id="runningTotalGrand">$0</span>
                </div>

                <!-- BOM Placeholder (shown in Draw step) -->
                <div id="bomPlaceholder" class="info-card bom-placeholder">
                  <div class="bom-placeholder-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto mb-3 opacity-40">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                    </svg>
                    <p class="text-gray-500 text-center">Complete the <strong>Structure</strong> step to see materials</p>
                  </div>
                </div>

                <!-- Quote View (shown during Review step) -->
                <div id="quoteView" class="quote-view hidden">
                  <div class="quote-header">
                    <div class="quote-header-brand">
                      <h2 class="quote-title">TUDS Pro Deck Estimator</h2>
                      <span class="quote-date" id="quoteDate"></span>
                    </div>
                    <div class="quote-project-name" id="quoteProjectName"></div>
                  </div>
                  <div class="quote-body" id="quoteBody">
                    <!-- Populated by JavaScript from BOM data -->
                  </div>
                  <div class="quote-actions">
                    <button type="button" class="btn btn-primary" onclick="openCartOptionsModal()" id="quoteAddToCartBtn">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path d="M1 1.75A.75.75 0 0 1 1.75 1h1.628a1.75 1.75 0 0 1 1.734 1.51L5.18 3a65.25 65.25 0 0 1 13.36 1.412.75.75 0 0 1 .58.875 48.645 48.645 0 0 1-1.618 6.2.75.75 0 0 1-.712.513H6a2.503 2.503 0 0 0-2.292 1.5H17.25a.75.75 0 0 1 0 1.5H2.76a.75.75 0 0 1-.748-.807 4.002 4.002 0 0 1 2.716-3.486L3.626 2.716a.25.25 0 0 0-.248-.216H1.75A.75.75 0 0 1 1 1.75ZM6 17.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM15.5 19a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                      </svg>
                      Add to Cart
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.print()">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.046.752.11 1.126.192A2.978 2.978 0 0 1 18 8.25v4.5A2.978 2.978 0 0 1 15.75 15.5H15v.75c0 .966-.784 1.75-1.75 1.75h-6.5A1.75 1.75 0 0 1 5 16.25V15.5h-.75A2.978 2.978 0 0 1 2 12.75v-4.5A2.978 2.978 0 0 1 4.25 5.5h.624c.374-.082.749-.146 1.126-.192V2.75ZM6.5 5.25V2.75a.25.25 0 0 1 .25-.25h6.5a.25.25 0 0 1 .25.25v2.5h-7Zm0 10.25v.75c0 .138.112.25.25.25h6.5a.25.25 0 0 0 .25-.25v-.75h-7Z" clip-rule="evenodd" />
                      </svg>
                      Print / PDF
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="exportToPDF()">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
                        <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
                      </svg>
                      Export
                    </button>
                  </div>
                </div>

                <div id="bomSection" class="info-card hidden">
                  <!-- Gating Notice for Non-Authenticated Users -->
                  <div id="bomGatingNotice" class="bom-gating-notice hidden">
                    <div class="gating-notice-content">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="gating-icon">
                        <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                      </svg>
                      <div class="gating-text">
                        <span class="gating-estimate">Estimated total: <strong id="bomEstimatedTotal">$0</strong></span>
                        <span class="gating-cta"><a href="#" onclick="openAuthModal(); return false;">Sign in</a> to see exact quantities, export PDFs, and add to cart</span>
                      </div>
                    </div>
                  </div>

                  <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-[#333333]">
                      Materials List
                    </h2>
                  </div>
                  
                  
                  <div class="flex justify-between items-center mb-4">
                    <div></div>
                    <div class="flex gap-2">
                      <button
                        type="button"
                        id="resetAllBomBtn"
                        class="btn btn-secondary px-3 py-1 text-sm"
                        onclick="resetAllQuantities()"
                        title="Reset all quantities to calculated values"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          class="w-4 h-4 inline-block mr-1 align-text-bottom"
                        >
                          <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201 2.466l-.312-.311h2.433a.75.75 0 000-1.5H3.989a.75.75 0 00-.75.75v4.242a.75.75 0 001.5 0v-2.43l.31.31a7 7 0 0011.712-3.138.75.75 0 00-1.449-.39zm1.23-3.723a.75.75 0 00.219-.53V2.929a.75.75 0 00-1.5 0V5.36l-.31-.31A7 7 0 003.239 8.188a.75.75 0 101.448.389A5.5 5.5 0 0113.89 6.11l.311.31h-2.432a.75.75 0 000 1.5h4.243a.75.75 0 00.53-.219z" clip-rule="evenodd" />
                        </svg>
                        Reset All
                      </button>
                      <button
                        type="button"
                        id="printBomBtn"
                        class="btn btn-secondary px-3 py-1 text-sm"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          class="w-4 h-4 inline-block mr-1 align-text-bottom"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.046.752.11 1.126.192.484.107.912.284 1.234.534a.75.75 0 0 1 0 1.244c-.322.25-.75.427-1.234.534a11.46 11.46 0 0 1-1.126.192v3.552c0 .966-.784 1.75-1.75 1.75h-6.5A1.75 1.75 0 0 1 5 14.25v-3.552a11.46 11.46 0 0 1-1.126-.192c-.484-.107-.912-.284-1.234-.534a.75.75 0 0 1 0-1.244c.322-.25.75-.427 1.234-.534A11.46 11.46 0 0 1 5 8.25V2.75Zm2.25 9.5a.75.75 0 0 0 .75.75h4a.75.75 0 0 0 .75-.75V8.75a.75.75 0 0 0-.75-.75h-4a.75.75 0 0 0-.75.75v3.5ZM5.28 3.22a.22.22 0 0 0-.221.28l.004.004a.753.753 0 0 0 .217.276V7.1a.75.75 0 0 0 .75.75h8.5a.75.75 0 0 0 .75-.75V3.78a.753.753 0 0 0 .217-.276l.004-.004a.22.22 0 0 0-.221-.28H5.28ZM3.5 7.875c0 .414.336.75.75.75h11.5a.75.75 0 0 0 .75-.75V4.125a.75.75 0 0 0-.75-.75H4.25a.75.75 0 0 0-.75.75v3.75Z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        Print
                      </button>
                      <button
                        type="button"
                        id="addToCartBtn"
                        class="btn btn-primary px-3 py-1 text-sm hidden"
                        title="Add materials to cart"
                        onclick="openCartOptionsModal()"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                          class="w-4 h-4 inline-block mr-1 align-text-bottom"
                        >
                          <path d="M1 1.75A.75.75 0 0 1 1.75 1h1.628a1.75 1.75 0 0 1 1.734 1.51L5.18 3a65.25 65.25 0 0 1 13.36 1.412.75.75 0 0 1 .58.875 48.645 48.645 0 0 1-1.618 6.2.75.75 0 0 1-.712.513H6a2.503 2.503 0 0 0-2.292 1.5H17.25a.75.75 0 0 1 0 1.5H2.76a.75.75 0 0 1-.748-.807 4.002 4.002 0 0 1 2.716-3.486L3.626 2.716a.25.25 0 0 0-.248-.216H1.75A.75.75 0 0 1 1 1.75ZM6 17.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM15.5 19a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                        </svg>
                        Add to Cart
                      </button>
                      <!-- Button shown when in selection mode -->
                      <button
                        type="button"
                        id="addSelectedToCartBtn"
                        class="btn btn-primary px-3 py-1 text-sm hidden"
                        title="Add selected items to cart"
                        onclick="handleAddSelectedToCart()"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mr-1 align-text-bottom">
                          <path d="M1 1.75A.75.75 0 0 1 1.75 1h1.628a1.75 1.75 0 0 1 1.734 1.51L5.18 3a65.25 65.25 0 0 1 13.36 1.412.75.75 0 0 1 .58.875 48.645 48.645 0 0 1-1.618 6.2.75.75 0 0 1-.712.513H6a2.503 2.503 0 0 0-2.292 1.5H17.25a.75.75 0 0 1 0 1.5H2.76a.75.75 0 0 1-.748-.807 4.002 4.002 0 0 1 2.716-3.486L3.626 2.716a.25.25 0 0 0-.248-.216H1.75A.75.75 0 0 1 1 1.75ZM6 17.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM15.5 19a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                        </svg>
                        Add Selected
                      </button>
                      <button
                        type="button"
                        id="cancelSelectionBtn"
                        class="btn btn-secondary px-3 py-1 text-sm hidden"
                        onclick="cancelItemSelection()"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="w-full bom-table">
                      <thead>
                        <tr>
                          <th class="checkbox-col hidden"><input type="checkbox" id="bomSelectAll" onchange="toggleAllBomItems(this.checked)" title="Select all"></th>
                          <th class="qty-col">Qty</th>
                          <th>Item</th>
                          <th>Description</th>
                          <th class="price-col">Unit Price</th>
                          <th class="price-col">Total Price</th>
                        </tr>
                      </thead>
                      <tbody id="bomTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Decking Tab Content -->
        <div
          id="decking-content"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="decking-tab"
        >
          <div id="decking-layout-container" class="flex flex-col lg:flex-row gap-8">
            <p class="text-muted text-center py-8 w-full">Decking calculator coming soon</p>
          </div>
        </div>

        <!-- Railing Tab Content -->
        <div
          id="railing-content"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="railing-tab"
        >
          <div id="railing-layout-container" class="flex flex-col lg:flex-row gap-8">
            <p class="text-muted text-center py-8 w-full">Railing calculator coming soon</p>
          </div>
        </div>

        <!-- Enhanced Summary Tab Content -->
        <div
          id="summary-content"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="summary-tab"
        >
          <div id="summary-layout-container" class="flex flex-col lg:flex-row gap-8">
            <p class="text-muted text-center py-8 w-full">Enhanced summary coming soon</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Structural Specifications Modal -->
    <div id="specsModal" class="specs-modal hidden" onclick="if(event.target === this) closeSpecsModal()">
      <div class="specs-modal-content">
        <div class="specs-modal-header">
          <div class="specs-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-[var(--tuds-green-dark)]">
              <path fill-rule="evenodd" d="M16.403 12.652a3 3 0 000-5.304 3 3 0 00-3.75-3.751 3 3 0 00-5.305 0 3 3 0 00-3.751 3.75 3 3 0 000 5.305 3 3 0 003.75 3.751 3 3 0 005.305 0 3 3 0 003.751-3.75zm-2.546-4.46a.75.75 0 00-1.214-.883l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <h2>Structural Specifications</h2>
            <span class="permit-badge">Permit-Ready</span>
          </div>
          <button type="button" class="specs-modal-close" onclick="closeSpecsModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        <p class="structural-specs-intro">
          Reference specifications for building permit applications. Verify all requirements with your local building authority.
        </p>

        <div class="specs-modal-body">
          <div class="structural-specs-grid">
            <!-- Design Loads -->
            <div class="spec-card">
              <div class="spec-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="spec-icon">
                  <path d="M10.75 10.818v2.614A3.13 3.13 0 0011.888 13c.482-.315.612-.648.612-.875 0-.227-.13-.56-.612-.875a3.13 3.13 0 00-1.138-.432zM8.33 8.62c.053.055.115.11.184.164.208.16.46.284.736.363V6.603a2.45 2.45 0 00-.35.13c-.14.065-.27.143-.386.233-.377.292-.514.627-.514.909 0 .184.058.39.202.592.037.051.08.102.128.152z" />
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-6a.75.75 0 01.75.75v.316a3.78 3.78 0 011.653.713c.426.33.744.74.925 1.2a.75.75 0 01-1.395.55 1.35 1.35 0 00-.447-.563 2.187 2.187 0 00-.736-.363V9.3c.698.093 1.383.32 1.959.696.787.514 1.29 1.27 1.29 2.13 0 .86-.504 1.616-1.29 2.13-.576.377-1.261.603-1.96.696v.299a.75.75 0 11-1.5 0v-.3c-.697-.092-1.382-.318-1.958-.695-.482-.315-.857-.717-1.078-1.188a.75.75 0 111.359-.636c.08.173.245.376.54.569.313.205.706.353 1.137.432v-2.748a3.782 3.782 0 01-1.653-.713C6.9 9.433 6.5 8.681 6.5 7.875c0-.805.4-1.558 1.088-2.066.27-.199.576-.356.912-.47V5.045a.75.75 0 01.75-.75c.41 0 .75.336.75.75z" clip-rule="evenodd" />
                </svg>
                <h3>Design Loads</h3>
              </div>
              <div class="spec-card-content">
                <div class="spec-row">
                  <span class="spec-label">Live Load (People/Furniture)</span>
                  <span class="spec-value" id="specLiveLoad">40 PSF</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Dead Load (Structure)</span>
                  <span class="spec-value" id="specDeadLoad">10 PSF</span>
                </div>
                <div class="spec-row highlight">
                  <span class="spec-label">Total Design Load</span>
                  <span class="spec-value" id="specTotalLoad">50 PSF</span>
                </div>
                <div class="spec-note">
                  Based on IRC R507.1 residential deck requirements
                </div>
              </div>
            </div>

            <!-- Joist Specifications -->
            <div class="spec-card">
              <div class="spec-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="spec-icon">
                  <path d="M3.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h12.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75H3.75zM5.5 5.5h9v9h-9v-9z" />
                </svg>
                <h3>Joist System</h3>
              </div>
              <div class="spec-card-content">
                <div class="spec-row">
                  <span class="spec-label">Joist Size</span>
                  <span class="spec-value" id="specJoistSize">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Spacing (O.C.)</span>
                  <span class="spec-value" id="specJoistSpacing">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Actual Span</span>
                  <span class="spec-value" id="specJoistActualSpan">--</span>
                </div>
                <div class="spec-row compliance">
                  <span class="spec-label">Max Allowable Span</span>
                  <span class="spec-value" id="specJoistMaxSpan">--</span>
                </div>
                <div class="spec-compliance-status" id="joistComplianceStatus">
                  <span class="compliance-icon"></span>
                  <span class="compliance-text">Calculating...</span>
                </div>
              </div>
            </div>

            <!-- Beam Specifications -->
            <div class="spec-card">
              <div class="spec-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="spec-icon">
                  <path fill-rule="evenodd" d="M4.25 2A2.25 2.25 0 002 4.25v11.5A2.25 2.25 0 004.25 18h11.5A2.25 2.25 0 0018 15.75V4.25A2.25 2.25 0 0015.75 2H4.25zM15 5.75a.75.75 0 00-1.5 0v8.5a.75.75 0 001.5 0v-8.5zm-8.5 6a.75.75 0 00-1.5 0v2.5a.75.75 0 001.5 0v-2.5zM8.584 9a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5a.75.75 0 01.75-.75zm3.58-1.25a.75.75 0 00-1.5 0v6.5a.75.75 0 001.5 0v-6.5z" clip-rule="evenodd" />
                </svg>
                <h3>Beam System</h3>
              </div>
              <div class="spec-card-content">
                <div class="spec-row">
                  <span class="spec-label">Beam Configuration</span>
                  <span class="spec-value" id="specBeamConfig">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Beam Type</span>
                  <span class="spec-value" id="specBeamType">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Total Beam Length</span>
                  <span class="spec-value" id="specBeamLength">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Number of Beams</span>
                  <span class="spec-value" id="specBeamCount">--</span>
                </div>
              </div>
            </div>

            <!-- Post & Foundation -->
            <div class="spec-card">
              <div class="spec-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="spec-icon">
                  <path fill-rule="evenodd" d="M9.674 2.075a.75.75 0 01.652 0l7.25 3.5A.75.75 0 0117 6.957V16.5h.25a.75.75 0 010 1.5H2.75a.75.75 0 010-1.5H3V6.957a.75.75 0 01-.576-1.382l7.25-3.5zM11 6a1 1 0 11-2 0 1 1 0 012 0zM7.5 9.75a.75.75 0 00-1.5 0v5.5a.75.75 0 001.5 0v-5.5zm3.25-.75a.75.75 0 01.75.75v5.5a.75.75 0 01-1.5 0v-5.5a.75.75 0 01.75-.75zm3.25.75a.75.75 0 00-1.5 0v5.5a.75.75 0 001.5 0v-5.5z" clip-rule="evenodd" />
                </svg>
                <h3>Posts & Foundations</h3>
              </div>
              <div class="spec-card-content">
                <div class="spec-row">
                  <span class="spec-label">Post Size</span>
                  <span class="spec-value" id="specPostSize">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Post Height</span>
                  <span class="spec-value" id="specPostHeight">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Number of Posts</span>
                  <span class="spec-value" id="specPostCount">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Max Post Spacing</span>
                  <span class="spec-value" id="specPostSpacing">8' O.C.</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Footing Type</span>
                  <span class="spec-value" id="specFootingType">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Number of Footings</span>
                  <span class="spec-value" id="specFootingCount">--</span>
                </div>
              </div>
            </div>

            <!-- Ledger Attachment -->
            <div class="spec-card">
              <div class="spec-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="spec-icon">
                  <path d="M10 1a6 6 0 00-3.815 10.631C7.237 12.5 8 13.443 8 14.456v.644a.75.75 0 00.572.729 6.016 6.016 0 002.856 0A.75.75 0 0012 15.1v-.644c0-1.013.762-1.957 1.815-2.825A6 6 0 0010 1zM8.863 17.414a.75.75 0 00-.226 1.483 9.066 9.066 0 002.726 0 .75.75 0 00-.226-1.483 7.553 7.553 0 01-2.274 0z" />
                </svg>
                <h3>Attachment Method</h3>
              </div>
              <div class="spec-card-content">
                <div class="spec-row">
                  <span class="spec-label">Attachment Type</span>
                  <span class="spec-value" id="specAttachmentType">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Ledger Size</span>
                  <span class="spec-value" id="specLedgerSize">--</span>
                </div>
                <div class="spec-row">
                  <span class="spec-label">Ledger Length</span>
                  <span class="spec-value" id="specLedgerLength">--</span>
                </div>
                <div class="spec-note" id="specLedgerNote">
                  Ledger attachment per IRC R507.9.1
                </div>
              </div>
            </div>

            <!-- Code References -->
            <div class="spec-card code-references">
              <div class="spec-card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="spec-icon">
                  <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" />
                </svg>
                <h3>Code References</h3>
              </div>
              <div class="spec-card-content">
                <ul class="code-reference-list">
                  <li><strong>IRC R507</strong> - Exterior Decks</li>
                  <li><strong>IRC R507.5</strong> - Deck Joists</li>
                  <li><strong>IRC R507.6</strong> - Deck Beams</li>
                  <li><strong>IRC R507.8</strong> - Deck Posts</li>
                  <li><strong>IRC R507.9</strong> - Deck Ledger Board</li>
                </ul>
                <div class="spec-disclaimer">
                  Always verify specifications with your local building department. Code requirements vary by jurisdiction.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="specs-modal-footer">
          <button type="button" id="printSpecsBtn" class="btn btn-secondary px-4 py-2 text-sm" onclick="window.print()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mr-1.5 align-text-bottom">
              <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.046.752.11 1.126.192.484.107.912.284 1.234.534a.75.75 0 010 1.244c-.322.25-.75.427-1.234.534a11.46 11.46 0 01-1.126.192v3.552c0 .966-.784 1.75-1.75 1.75h-6.5A1.75 1.75 0 015 14.25v-3.552a11.46 11.46 0 01-1.126-.192c-.484-.107-.912-.284-1.234-.534a.75.75 0 010-1.244c.322-.25.75-.427 1.234-.534A11.46 11.46 0 015 8.25V2.75z" clip-rule="evenodd" />
            </svg>
            Print Specifications
          </button>
          <button type="button" class="btn btn-primary px-4 py-2 text-sm" onclick="closeSpecsModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Cut List Modal -->
    <div id="cutListModal" class="cut-list-modal hidden" onclick="if(event.target === this) closeCutListModal()">
      <div class="cut-list-modal-content">
        <div class="cut-list-modal-header">
          <div class="cut-list-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-[var(--tuds-green-dark)]">
              <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zM6 7a.75.75 0 000 1.5h8A.75.75 0 0014 7H6zm0 3.5a.75.75 0 000 1.5h8a.75.75 0 000-1.5H6zm0 3.5a.75.75 0 000 1.5h5a.75.75 0 000-1.5H6z" clip-rule="evenodd" />
            </svg>
            <h2>Framing Cut List</h2>
            <span class="cut-list-badge">For Construction</span>
          </div>
          <button type="button" class="cut-list-modal-close" onclick="closeCutListModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        <p class="cut-list-intro">
          Detailed lumber cut list with component labels matching the diagram. Print for easy reference during construction.
        </p>

        <div class="cut-list-modal-body">
          <!-- Summary Stats -->
          <div class="cut-list-summary">
            <div class="cut-list-stat">
              <span class="stat-value" id="cutListTotalPieces">0</span>
              <span class="stat-label">Total Pieces</span>
            </div>
            <div class="cut-list-stat">
              <span class="stat-value" id="cutListTotalLF">0</span>
              <span class="stat-label">Linear Feet</span>
            </div>
            <div class="cut-list-stat">
              <span class="stat-value" id="cutListUniqueTypes">0</span>
              <span class="stat-label">Unique Sizes</span>
            </div>
          </div>

          <!-- Cut List Table -->
          <div class="cut-list-table-container">
            <table class="cut-list-table">
              <thead>
                <tr>
                  <th class="label-col">Label</th>
                  <th class="type-col">Component</th>
                  <th class="size-col">Size</th>
                  <th class="length-col">Length</th>
                  <th class="qty-col">Qty</th>
                </tr>
              </thead>
              <tbody id="cutListTableBody">
                <!-- Cut list items will be populated here -->
              </tbody>
            </table>
          </div>

          <!-- Grouped by size summary -->
          <div class="cut-list-grouped">
            <h3>Summary by Size</h3>
            <div id="cutListGroupedContent">
              <!-- Grouped summary will be populated here -->
            </div>
          </div>
        </div>

        <div class="cut-list-modal-footer">
          <button type="button" id="printCutListBtn" class="btn btn-secondary px-4 py-2 text-sm" onclick="printCutList()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mr-1.5 align-text-bottom">
              <path fill-rule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.046.752.11 1.126.192.484.107.912.284 1.234.534a.75.75 0 010 1.244c-.322.25-.75.427-1.234.534a11.46 11.46 0 01-1.126.192v3.552c0 .966-.784 1.75-1.75 1.75h-6.5A1.75 1.75 0 015 14.25v-3.552a11.46 11.46 0 01-1.126-.192c-.484-.107-.912-.284-1.234-.534a.75.75 0 010-1.244c.322-.25.75-.427 1.234-.534A11.46 11.46 0 015 8.25V2.75z" clip-rule="evenodd" />
            </svg>
            Print Cut List
          </button>
          <button type="button" class="btn btn-primary px-4 py-2 text-sm" onclick="closeCutListModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- 3D Preview Modal -->
    <div id="preview3DModal" class="preview3d-modal hidden" onclick="if(event.target === this) close3DPreview()">
      <div class="preview3d-modal-content">
        <div class="preview3d-modal-header">
          <div class="preview3d-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-[var(--tuds-green-dark)]">
              <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" />
            </svg>
            <h2>3D Preview</h2>
            <span class="preview3d-badge">Isometric View</span>
          </div>
          <button type="button" class="preview3d-modal-close" onclick="close3DPreview()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        <div class="preview3d-controls">
          <div class="preview3d-control-group">
            <label>View Angle</label>
            <div class="preview3d-angle-btns">
              <button type="button" class="angle-btn active" data-angle="front-right" onclick="set3DAngle('front-right')">Front-Right</button>
              <button type="button" class="angle-btn" data-angle="front-left" onclick="set3DAngle('front-left')">Front-Left</button>
              <button type="button" class="angle-btn" data-angle="back-right" onclick="set3DAngle('back-right')">Back-Right</button>
              <button type="button" class="angle-btn" data-angle="back-left" onclick="set3DAngle('back-left')">Back-Left</button>
            </div>
          </div>
          <div class="preview3d-control-group">
            <label>Show Layers</label>
            <div class="preview3d-layer-toggles">
              <label class="layer-toggle"><input type="checkbox" id="show3d-decking" checked onchange="update3DPreview()"><span>Decking</span></label>
              <label class="layer-toggle"><input type="checkbox" id="show3d-joists" checked onchange="update3DPreview()"><span>Joists</span></label>
              <label class="layer-toggle"><input type="checkbox" id="show3d-beams" checked onchange="update3DPreview()"><span>Beams</span></label>
              <label class="layer-toggle"><input type="checkbox" id="show3d-posts" checked onchange="update3DPreview()"><span>Posts</span></label>
            </div>
          </div>
        </div>

        <div class="preview3d-modal-body">
          <canvas id="preview3DCanvas" width="800" height="600"></canvas>
          <div class="preview3d-info">
            <span id="preview3dDimensions">-</span>
          </div>
        </div>

        <div class="preview3d-modal-footer">
          <button type="button" class="btn btn-secondary px-4 py-2 text-sm" onclick="download3DPreview()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mr-1.5 align-text-bottom">
              <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
              <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
            </svg>
            Download Image
          </button>
          <button type="button" class="btn btn-primary px-4 py-2 text-sm" onclick="close3DPreview()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Help Wizard Overlay -->
    <div id="helpWizardOverlay" class="help-wizard-overlay hidden">
      <!-- Spotlight highlight element -->
      <div id="wizardSpotlight" class="wizard-spotlight"></div>

      <!-- Tooltip container -->
      <div id="wizardTooltip" class="wizard-tooltip">
        <div class="wizard-tooltip-header">
          <span class="wizard-step-indicator" id="wizardStepIndicator">Step 1 of 8</span>
          <button type="button" class="wizard-close-btn" onclick="endHelpWizard()" title="Close tutorial">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
        <div class="wizard-tooltip-content">
          <h3 id="wizardTitle" class="wizard-title">Welcome to TUDS Pro Deck Estimator</h3>
          <p id="wizardDescription" class="wizard-description">Let's take a quick tour of the main features to help you get started.</p>
        </div>
        <div class="wizard-tooltip-footer">
          <button type="button" id="wizardPrevBtn" class="btn btn-secondary wizard-btn" onclick="prevWizardStep()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
              <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
            </svg>
            Back
          </button>
          <div class="wizard-progress">
            <div id="wizardProgressDots" class="wizard-progress-dots"></div>
          </div>
          <button type="button" id="wizardNextBtn" class="btn btn-primary wizard-btn" onclick="nextWizardStep()">
            Next
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
              <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
        <div class="wizard-skip-link">
          <button type="button" class="wizard-skip-btn" onclick="endHelpWizard()">Skip tutorial</button>
        </div>
      </div>
    </div>

    <!-- Projects Modal -->
    <div id="projectsModal" class="projects-modal hidden" onclick="if(event.target === this) closeProjectsModal()">
      <div class="projects-modal-content">
        <div class="projects-modal-header">
          <div class="projects-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
              <path fill-rule="evenodd" d="M4.25 2A2.25 2.25 0 002 4.25v11.5A2.25 2.25 0 004.25 18h11.5A2.25 2.25 0 0018 15.75V4.25A2.25 2.25 0 0015.75 2H4.25zm4.03 6.28a.75.75 0 00-1.06-1.06L4.97 9.47a.75.75 0 000 1.06l2.25 2.25a.75.75 0 001.06-1.06L6.56 10l1.72-1.72zm4.5-1.06a.75.75 0 10-1.06 1.06L13.44 10l-1.72 1.72a.75.75 0 101.06 1.06l2.25-2.25a.75.75 0 000-1.06l-2.25-2.25z" clip-rule="evenodd" />
            </svg>
            <h2>TUDS Pro Deck Estimator</h2>
          </div>
          <button type="button" class="projects-modal-close" onclick="closeProjectsModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        <div class="projects-modal-body">
          <!-- Sign-in Section for non-authenticated users (shown at top) -->
          <div id="projectsSignInSection" class="sign-in-section">
            <div class="sign-in-section-content">
              <div class="sign-in-section-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="sign-in-section-text">
                <h3>Sign in to save your projects</h3>
                <p>Access your designs from any device and never lose your work</p>
              </div>
              <button type="button" class="btn btn-primary" onclick="openAuthModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 01-1.5 0v-2a.75.75 0 00-.75-.75h-5.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 00.75-.75v-2a.75.75 0 011.5 0v2A2.25 2.25 0 0110.75 18h-5.5A2.25 2.25 0 013 15.75V4.25z" clip-rule="evenodd" />
                  <path fill-rule="evenodd" d="M19 10a.75.75 0 00-.75-.75H8.704l1.048-.943a.75.75 0 10-1.004-1.114l-2.5 2.25a.75.75 0 000 1.114l2.5 2.25a.75.75 0 101.004-1.114l-1.048-.943h9.546A.75.75 0 0019 10z" clip-rule="evenodd" />
                </svg>
                Sign In
              </button>
            </div>
          </div>

          <!-- Save New Project Section -->
          <div class="save-project-section">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
              </svg>
              Start New Project
            </h3>
            <form id="saveProjectForm" class="save-project-form" onsubmit="handleSaveProject(event)">
              <!-- Store/Salesperson row - only visible for internal staff -->
              <div id="storeFieldsRow" class="form-row-group">
                <div class="form-row form-row-half">
                  <label for="saveProjectStore">Store</label>
                  <select id="saveProjectStore" onchange="updateSalespersonDropdown()">
                    <option value="">Select Store...</option>
                  </select>
                </div>
                <div class="form-row form-row-half">
                  <label for="saveProjectSalesperson">Salesperson</label>
                  <select id="saveProjectSalesperson">
                    <option value="">Select Person...</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <label for="saveProjectName">Project Name</label>
                <input
                  type="text"
                  id="saveProjectName"
                  placeholder="e.g., Smith Residence - Backyard Deck"
                  required
                  maxlength="100"
                />
              </div>
              <div class="form-row customer-info-row">
                <div class="customer-info-toggle">
                  <label>
                    <input type="checkbox" id="includeCustomerInfo" onchange="toggleCustomerInfoFields()">
                    <span>Include Customer Info</span>
                  </label>
                </div>
              </div>
              <div id="customerInfoFields" class="customer-info-fields hidden">
                <div class="form-row">
                  <label for="customerName">Customer Name</label>
                  <input type="text" id="customerName" placeholder="John Smith" maxlength="100" />
                </div>
                <div class="form-row">
                  <label for="customerPhone">Phone</label>
                  <input type="tel" id="customerPhone" placeholder="(555) 123-4567" maxlength="20" />
                </div>
                <div class="form-row">
                  <label for="customerEmail">Email</label>
                  <input type="email" id="customerEmail" placeholder="john@example.com" maxlength="100" />
                </div>
                <div class="form-row">
                  <label for="customerAddress">Address</label>
                  <input type="text" id="customerAddress" placeholder="123 Main St, City" maxlength="200" />
                </div>
              </div>
              <button type="submit" class="btn btn-primary save-project-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 0016 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                </svg>
                Start Project
              </button>
            </form>
          </div>

          <!-- Saved Projects List - only shown when signed in -->
          <div id="savedProjectsSection" class="saved-projects-section hidden">
            <div class="projects-tabs" id="projectsTabs">
              <button type="button" class="projects-tab active" data-tab="my" onclick="switchProjectsTab('my')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
                </svg>
                My Projects
                <span id="myProjectsCount" class="tab-count"></span>
              </button>
              <button type="button" class="projects-tab" data-tab="store" onclick="switchProjectsTab('store')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 01-2.07-.655zM16.44 15.98a4.97 4.97 0 002.07-.654.78.78 0 00.357-.442 3 3 0 00-4.308-3.517 6.484 6.484 0 011.907 3.96 2.32 2.32 0 01-.026.654zM18 8a2 2 0 11-4 0 2 2 0 014 0zM5.304 16.19a.844.844 0 01-.277-.71 5 5 0 019.947 0 .843.843 0 01-.277.71A6.975 6.975 0 0110 18a6.974 6.974 0 01-4.696-1.81z" />
                </svg>
                Store Projects
                <span id="storeProjectsCount" class="tab-count"></span>
              </button>
            </div>
            <div id="projectsFiltersRow" class="projects-filters">
              <div class="filter-row">
                <div class="filter-group">
                  <label for="filterSalesperson">Person:</label>
                  <select id="filterSalesperson" onchange="renderProjectsList()">
                    <option value="all">All</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label for="filterSort">Sort:</label>
                  <select id="filterSort" onchange="renderProjectsList()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name">By Name</option>
                  </select>
                </div>
              </div>
            </div>
            <div id="projectsList" class="projects-list">
              <div class="no-projects">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-12 h-12">
                  <path d="M2 4.75C2 3.784 2.784 3 3.75 3h4.836c.464 0 .909.184 1.237.513l1.414 1.414a.25.25 0 00.177.073h4.836c.966 0 1.75.784 1.75 1.75v8.5A1.75 1.75 0 0116.25 17H3.75A1.75 1.75 0 012 15.25V4.75z" />
                </svg>
                <p>No saved projects yet</p>
                <span>Save your current design to access it later</span>
              </div>
            </div>
          </div>
        </div>

        <div class="projects-modal-footer">
          <div class="footer-buttons">
            <button type="button" class="btn btn-outline-primary btn-exploring" onclick="closeProjectsModal()" title="Start designing without saving">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z" clip-rule="evenodd" />
                <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z" clip-rule="evenodd" />
              </svg>
              Just exploring - skip to designer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal hidden" onclick="if(event.target === this) closeAuthModal()">
      <div class="auth-modal-content">
        <div class="auth-modal-header">
          <div class="auth-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
              <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
            </svg>
            <h2 id="authModalTitle">Sign In</h2>
          </div>
          <button type="button" class="auth-modal-close" onclick="closeAuthModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        <div class="auth-modal-body">
          <!-- Auth Error Message -->
          <div id="authError" class="auth-error hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <span id="authErrorText">Error message</span>
          </div>

          <!-- Google Sign In -->
          <button type="button" class="btn btn-google" onclick="handleGoogleSignIn()">
            <svg viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>

          <div class="auth-divider">
            <span>or</span>
          </div>

          <!-- Sign In Form -->
          <form id="signInForm" class="auth-form" onsubmit="handleEmailSignIn(event)">
            <div class="form-row">
              <label for="authEmail">Email</label>
              <input type="email" id="authEmail" placeholder="you@example.com" required />
            </div>
            <div class="form-row">
              <label for="authPassword">Password</label>
              <input type="password" id="authPassword" placeholder="Enter your password" required minlength="6" />
            </div>
            <div id="signUpNameRow" class="form-row hidden">
              <label for="authDisplayName">Your Name</label>
              <input type="text" id="authDisplayName" placeholder="John Smith" />
            </div>
            <div id="signUpPhoneRow" class="form-row hidden">
              <label for="authPhone">Phone Number <span class="required-indicator">*</span></label>
              <input type="tel" id="authPhone" placeholder="(555) 123-4567" />
              <span class="form-hint">Required for order updates and support</span>
            </div>
            <div id="signUpStoreRow" class="form-row hidden">
              <label for="authStoreSelect">Your Store Location <span class="required-indicator">*</span></label>
              <select id="authStoreSelect">
                <option value="">Select your store...</option>
                <option value="tuds-regina">Regina</option>
                <option value="tuds-saskatoon">Saskatoon</option>
              </select>
              <span class="form-hint">Select the store you work at</span>
            </div>
            <button type="submit" class="btn btn-primary btn-full-width" id="authSubmitBtn">
              Sign In
            </button>
          </form>

          <!-- Forgot Password Link -->
          <div id="forgotPasswordLink" class="auth-link">
            <button type="button" class="btn-link" onclick="handleForgotPassword()">Forgot your password?</button>
          </div>

          <!-- Toggle Sign In / Sign Up -->
          <div class="auth-toggle">
            <span id="authToggleText">Don't have an account?</span>
            <button type="button" class="btn-link" id="authToggleBtn" onclick="toggleAuthMode()">Sign Up</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Phone Collection Modal (for Google Sign-In users) -->
    <div id="phoneModal" class="auth-modal hidden" onclick="event.stopPropagation()">
      <div class="auth-modal-content phone-modal-content">
        <div class="auth-modal-header">
          <div class="auth-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
              <path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 013.5 2h1.148a1.5 1.5 0 011.465 1.175l.716 3.223a1.5 1.5 0 01-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 006.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 011.767-1.052l3.223.716A1.5 1.5 0 0118 15.352V16.5a1.5 1.5 0 01-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 012.43 8.326 13.019 13.019 0 012 5V3.5z" clip-rule="evenodd" />
            </svg>
            <h2>Complete Your Profile</h2>
          </div>
        </div>
        <div class="auth-modal-body">
          <p class="phone-modal-description">
            Please provide your phone number to complete your account setup. This helps us provide order updates and support.
          </p>
          <div id="phoneError" class="auth-error hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <span id="phoneErrorText">Error message</span>
          </div>
          <form id="phoneForm" class="auth-form" onsubmit="handlePhoneSubmit(event)">
            <div class="form-row">
              <label for="modalPhone">Phone Number <span class="required-indicator">*</span></label>
              <input type="tel" id="modalPhone" placeholder="(555) 123-4567" required />
            </div>
            <button type="submit" class="btn btn-primary btn-full-width" id="phoneSubmitBtn">
              Save Phone Number
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Cart Options Modal -->
    <div id="cartOptionsModal" class="auth-modal hidden" onclick="if(event.target === this) closeCartOptionsModal()">
      <div class="auth-modal-content cart-options-modal-content">
        <div class="auth-modal-header">
          <div class="auth-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
              <path d="M1 1.75A.75.75 0 0 1 1.75 1h1.628a1.75 1.75 0 0 1 1.734 1.51L5.18 3a65.25 65.25 0 0 1 13.36 1.412.75.75 0 0 1 .58.875 48.645 48.645 0 0 1-1.618 6.2.75.75 0 0 1-.712.513H6a2.503 2.503 0 0 0-2.292 1.5H17.25a.75.75 0 0 1 0 1.5H2.76a.75.75 0 0 1-.748-.807 4.002 4.002 0 0 1 2.716-3.486L3.626 2.716a.25.25 0 0 0-.248-.216H1.75A.75.75 0 0 1 1 1.75ZM6 17.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM15.5 19a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
            </svg>
            <h2>Add to Cart</h2>
          </div>
          <button type="button" class="auth-modal-close" onclick="closeCartOptionsModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
        <div class="auth-modal-body">
          <p class="cart-options-description">
            How would you like to order your materials?
          </p>

          <div class="cart-option-buttons">
            <!-- Option 1: Full Order -->
            <button type="button" class="cart-option-btn" onclick="handleAddFullOrder()">
              <div class="cart-option-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8">
                  <path fill-rule="evenodd" d="M6 5v1H4.667a1.75 1.75 0 00-1.743 1.598l-.826 9.5A1.75 1.75 0 003.84 19H16.16a1.75 1.75 0 001.743-1.902l-.826-9.5A1.75 1.75 0 0015.333 6H14V5a4 4 0 00-8 0zm4-2.5A2.5 2.5 0 007.5 5v1h5V5A2.5 2.5 0 0010 2.5z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="cart-option-text">
                <span class="cart-option-title">Add Full Order</span>
                <span class="cart-option-desc">All materials — pickup or freight delivery</span>
              </div>
            </button>

            <!-- Option 2: Shippable Items Only -->
            <button type="button" class="cart-option-btn" onclick="handleAddShippableOnly()">
              <div class="cart-option-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8">
                  <path d="M6.5 3c-1.051 0-2.093.04-3.125.117A1.49 1.49 0 002 4.607V10.5h9V4.606c0-.771-.59-1.43-1.375-1.489A41.568 41.568 0 006.5 3zM2 12v2.5A1.5 1.5 0 003.5 16h.041a3 3 0 015.918 0h.791a.75.75 0 00.75-.75V12H2z"/>
                  <path d="M6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM13.25 5a.75.75 0 00-.75.75v8.514a3.001 3.001 0 014.893 1.44c.37-.275.607-.719.607-1.22V6.75a.75.75 0 00-.75-.75h-4z"/>
                  <path d="M15.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                </svg>
              </div>
              <div class="cart-option-text">
                <span class="cart-option-title">Ship Small Items</span>
                <span class="cart-option-desc">Hardware & fasteners — I'll source lumber locally</span>
              </div>
            </button>

            <!-- Option 3: Choose Items -->
            <button type="button" class="cart-option-btn cart-option-secondary" onclick="handleChooseItems()">
              <div class="cart-option-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8">
                  <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="cart-option-text">
                <span class="cart-option-title">Let Me Choose</span>
                <span class="cart-option-desc">Select specific items from the list</span>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal" class="auth-modal hidden" onclick="if(event.target === this) closeAdminPasswordModal()">
      <div class="auth-modal-content" style="max-width: 320px;">
        <div class="auth-modal-header">
          <div class="auth-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
              <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
            </svg>
            <h2>Admin Access</h2>
          </div>
          <button type="button" class="auth-modal-close" onclick="closeAdminPasswordModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
        <div class="auth-modal-body">
          <div id="adminPasswordError" class="auth-error hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <span>Incorrect password</span>
          </div>
          <form onsubmit="handleAdminPasswordSubmit(event)">
            <div class="form-row">
              <label for="adminPasswordInput">Password</label>
              <input type="password" id="adminPasswordInput" placeholder="Enter admin password" required autocomplete="current-password" />
            </div>
            <button type="submit" class="btn btn-primary btn-full-width">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
              </svg>
              Unlock Settings
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal hidden" onclick="if(event.target === this) closeSettingsModal()">
      <div class="settings-modal-content">
        <div class="settings-modal-header">
          <div class="settings-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
              <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 018.82 1h2.36a1 1 0 01.98.804l.331 1.652a6.993 6.993 0 011.929 1.115l1.598-.54a1 1 0 011.186.447l1.18 2.044a1 1 0 01-.205 1.251l-1.267 1.113a7.047 7.047 0 010 2.228l1.267 1.113a1 1 0 01.206 1.25l-1.18 2.045a1 1 0 01-1.187.447l-1.598-.54a6.993 6.993 0 01-1.929 1.115l-.33 1.652a1 1 0 01-.98.804H8.82a1 1 0 01-.98-.804l-.331-1.652a6.993 6.993 0 01-1.929-1.115l-1.598.54a1 1 0 01-1.186-.447l-1.18-2.044a1 1 0 01.205-1.251l1.267-1.114a7.05 7.05 0 010-2.227L1.821 7.773a1 1 0 01-.206-1.25l1.18-2.045a1 1 0 011.187-.447l1.598.54A6.993 6.993 0 017.51 3.456l.33-1.652zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
            </svg>
            <h2>Settings</h2>
          </div>
          <button type="button" class="settings-modal-close" onclick="closeSettingsModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>

        <div class="settings-modal-body">
          <!-- Store Locations Section -->
          <div class="settings-section">
            <h3 class="settings-section-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path fill-rule="evenodd" d="M4 16.5v-13h-.25a.75.75 0 010-1.5h12.5a.75.75 0 010 1.5H16v13h.25a.75.75 0 010 1.5h-3.5a.75.75 0 01-.75-.75v-2.5a.75.75 0 00-.75-.75h-2.5a.75.75 0 00-.75.75v2.5a.75.75 0 01-.75.75h-3.5a.75.75 0 010-1.5H4zm3-11a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-1zM7.5 9a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h1a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-1zM11 5.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-1zm.5 3.5a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h1a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-1z" clip-rule="evenodd" />
              </svg>
              Store Locations
            </h3>
            <p class="settings-section-description">
              Manage store locations. Each store can have its own staff members and projects.
            </p>
            <div id="storeLocationsList" class="store-locations-list">
              <!-- Populated dynamically -->
            </div>
            <div class="add-store-section">
              <input type="text" id="newCloudStoreName" placeholder="New store name (e.g., Calgary)" maxlength="50" aria-label="New store name" />
              <button type="button" class="btn btn-secondary btn-sm" onclick="handleAddCloudStore()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Store
              </button>
            </div>
          </div>

          <!-- Store Members Section -->
          <div class="settings-section settings-section-memberships">
            <h3 class="settings-section-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 01-2.07-.655zM16.44 15.98a4.97 4.97 0 002.07-.654.78.78 0 00.357-.442 3 3 0 00-4.308-3.517 6.484 6.484 0 011.907 3.96 2.32 2.32 0 01-.026.654zM18 8a2 2 0 11-4 0 2 2 0 014 0zM5.304 16.19a.844.844 0 01-.277-.71 5 5 0 019.947 0 .843.843 0 01-.277.71A6.975 6.975 0 0110 18a6.974 6.974 0 01-4.696-1.81z" />
              </svg>
              Store Members
            </h3>
            <p class="settings-section-description">
              Manage staff members for each store. Members can view and edit projects for their assigned store.
            </p>
            <div class="membership-store-select">
              <label for="membershipStoreSelect">Select Store:</label>
              <select id="membershipStoreSelect" onchange="loadStoreMembersAdmin()">
                <option value="">Choose a store...</option>
              </select>
            </div>
            <div id="storeMembersList" class="store-members-list">
              <p class="no-store-selected">Select a store above to manage members</p>
            </div>
            <div id="addMemberSection" class="add-member-section hidden">
              <input type="email" id="newMemberEmail" placeholder="user@example.com" aria-label="User email to add" />
              <button type="button" class="btn btn-secondary btn-sm" onclick="handleAddStoreMember()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path d="M11 5a3 3 0 11-6 0 3 3 0 016 0zM2.046 15.253c-.058.468.172.92.57 1.175A9.953 9.953 0 008 18c1.982 0 3.83-.578 5.384-1.573.398-.254.628-.707.57-1.175a6.001 6.001 0 00-11.908 0zM12.75 7.75a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z" />
                </svg>
                Add Member
              </button>
            </div>
            <div class="settings-notice membership-notice">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
              </svg>
              <span>Store members can see each other's projects. Requires Firebase setup.</span>
            </div>
          </div>

          <div class="settings-section settings-section-password">
            <h3 class="settings-section-title">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
              </svg>
              Admin Password
            </h3>
            <div class="change-password-form">
              <input type="password" id="newAdminPassword" placeholder="New password..." minlength="4" aria-label="New admin password" />
              <input type="password" id="confirmAdminPassword" placeholder="Confirm password..." minlength="4" aria-label="Confirm admin password" />
              <button type="button" class="btn btn-secondary btn-sm" onclick="handleChangePassword()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                </svg>
                Update Password
              </button>
            </div>
          </div>
        </div>

        <div class="settings-modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Mobile Bottom Navigation (shown only on mobile) -->
    <nav id="mobileBottomNav" class="mobile-bottom-nav" aria-label="Wizard Steps">
      <button type="button" class="mobile-nav-item active" data-step="draw" onclick="navigateToStep('draw')">
        <span class="nav-step-number">1</span>
        <span class="nav-label">Draw</span>
      </button>
      <button type="button" class="mobile-nav-item" data-step="structure" onclick="navigateToStep('structure')">
        <span class="nav-step-number">2</span>
        <span class="nav-label">Structure</span>
      </button>
      <button type="button" class="mobile-nav-item" data-step="stairs" onclick="navigateToStep('stairs')">
        <span class="nav-step-number">3</span>
        <span class="nav-label">Stairs</span>
      </button>
      <button type="button" class="mobile-nav-item" data-step="materials" onclick="navigateToStep('materials')">
        <span class="nav-step-number">4</span>
        <span class="nav-label">Materials</span>
      </button>
      <button type="button" class="mobile-nav-item" data-step="summary" onclick="navigateToStep('summary')">
        <span class="nav-step-number">5</span>
        <span class="nav-label">Summary</span>
      </button>
    </nav>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="auth-modal hidden" onclick="if(event.target === this) closeFeedbackModal()">
      <div id="feedbackModalContent" class="auth-modal-content draggable-modal" style="max-width: 500px;">
        <div class="auth-modal-header draggable-handle" style="cursor: move;">
          <div class="auth-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-[var(--tuds-green-dark)]">
              <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293c.121-.233.362-.393.642-.413 1.198-.087 2.382-.226 3.55-.414 1.437-.232 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.29 41.29 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <h2>Report Issue / Feedback</h2>
          </div>
          <button type="button" class="auth-modal-close" onclick="closeFeedbackModal()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
        <div class="auth-modal-body">
          <div id="feedbackSuccess" class="feedback-success hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-12 h-12 text-green-500 mx-auto">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <p class="text-center mt-4 text-green-700 font-medium">Feedback report saved!</p>
            <p class="text-center text-sm text-gray-600 mt-2">Thank you for helping improve the app.</p>
          </div>
          <form id="feedbackForm" class="auth-form" onsubmit="handleFeedbackSubmit(event)">
            <div class="form-row">
              <label for="feedbackIssueType">Issue Type</label>
              <select id="feedbackIssueType" required>
                <option value="">Select type...</option>
                <option value="rendering">Drawing/Rendering Issue</option>
                <option value="calculation">Calculation Error</option>
                <option value="ui">UI/UX Problem</option>
                <option value="crash">App Crash/Freeze</option>
                <option value="feature">Feature Request</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-row">
              <label for="feedbackDescription">Description <span class="required-indicator">*</span></label>
              <textarea id="feedbackDescription" rows="4" placeholder="Describe what happened or what you expected..." required style="resize: vertical;"></textarea>
            </div>
            <div class="form-row">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="feedbackIncludeScreenshot" checked class="w-4 h-4" onchange="updateFeedbackPreview()" />
                <span>Include screenshot</span>
              </label>
              <div id="screenshotTypeOptions" class="ml-6 mt-2 space-y-1">
                <label class="flex items-center gap-2 cursor-pointer text-sm">
                  <input type="radio" name="screenshotType" value="canvas" checked class="w-4 h-4" onchange="updateFeedbackPreview()" />
                  <span>Canvas only</span>
                  <span class="text-xs text-gray-400">(deck drawing)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer text-sm">
                  <input type="radio" name="screenshotType" value="fullpage" class="w-4 h-4" onchange="updateFeedbackPreview()" />
                  <span>Full page</span>
                  <span class="text-xs text-gray-400">(includes BOM & toolbar)</span>
                </label>
              </div>
            </div>
            <div class="form-row">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="feedbackIncludeTechData" checked class="w-4 h-4" onchange="updateFeedbackPreview()" />
                <span>Include technical data</span>
              </label>
              <p class="text-xs text-gray-500 mt-1">Includes deck dimensions, settings, and structural data for debugging.</p>
            </div>
            <div id="feedbackPreviewSection" class="feedback-preview mt-4" style="display: none;">
              <label class="text-sm font-medium text-gray-700">Preview:</label>
              <img id="feedbackPreviewImg" class="w-full border rounded mt-2" style="max-height: 150px; object-fit: contain; display: none;" />
              <pre id="feedbackTechDataPre" class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto" style="max-height: 150px; display: none;"></pre>
            </div>
            <div class="flex gap-3 mt-4">
              <button type="button" class="btn btn-secondary flex-1" onclick="downloadFeedbackReport()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mr-1">
                  <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                  <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                </svg>
                Download Report
              </button>
              <button type="submit" class="btn btn-primary flex-1">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block mr-1">
                  <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.086l-1.414 4.926a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.289z" />
                </svg>
                Submit Feedback
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Feedback Admin Modal -->
    <div id="feedbackAdminModal" class="auth-modal hidden" onclick="if(event.target === this) closeFeedbackAdmin()">
      <div class="auth-modal-content" style="max-width: 900px; max-height: 90vh;">
        <div class="auth-modal-header">
          <div class="auth-modal-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-[var(--tuds-green-dark)]">
              <path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293c.121-.233.362-.393.642-.413 1.198-.087 2.382-.226 3.55-.414 1.437-.232 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.29 41.29 0 0010 2zm0 7a1 1 0 100-2 1 1 0 000 2zM8 8a1 1 0 11-2 0 1 1 0 012 0zm5 1a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            <h2>Feedback Admin</h2>
          </div>
          <button type="button" class="auth-modal-close" onclick="closeFeedbackAdmin()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
        <div class="auth-modal-body" style="overflow: hidden; display: flex; flex-direction: column;">
          <!-- Stats Bar -->
          <div id="feedbackStats" class="flex gap-4 mb-4 p-3 bg-gray-100 rounded-lg text-sm">
            <span><strong>Total:</strong> <span id="feedbackCountTotal">0</span></span>
            <span class="text-yellow-600"><strong>Pending:</strong> <span id="feedbackCountPending">0</span></span>
            <span class="text-blue-600"><strong>In Progress:</strong> <span id="feedbackCountProgress">0</span></span>
            <span class="text-green-600"><strong>Resolved:</strong> <span id="feedbackCountResolved">0</span></span>
          </div>

          <!-- Filter and Actions -->
          <div class="flex gap-3 mb-4 items-center">
            <select id="feedbackFilterStatus" class="form-select" onchange="loadFeedbackAdmin()">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
              <option value="wont_fix">Won't Fix</option>
            </select>
            <button type="button" class="btn btn-secondary" onclick="loadFeedbackAdmin()">
              Refresh
            </button>
            <button type="button" class="btn btn-primary" onclick="exportAllFeedback()">
              Export All to File
            </button>
          </div>

          <!-- Feedback List -->
          <div id="feedbackAdminList" class="flex-1 overflow-y-auto" style="max-height: 50vh;">
            <p class="text-gray-500 text-center py-8">Loading feedback...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Detail Modal -->
    <div id="feedbackDetailModal" class="auth-modal hidden" onclick="if(event.target === this) closeFeedbackDetail()">
      <div class="auth-modal-content" style="max-width: 800px; max-height: 90vh;">
        <div class="auth-modal-header">
          <div class="auth-modal-title">
            <h2>Feedback Details</h2>
          </div>
          <button type="button" class="auth-modal-close" onclick="closeFeedbackDetail()" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
        <div class="auth-modal-body" style="overflow-y: auto; max-height: 70vh;">
          <div id="feedbackDetailContent">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
